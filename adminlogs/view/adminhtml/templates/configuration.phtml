<?php
use MiniOrange\AdminLogs\Helper\Curl;
use MiniOrange\AdminLogs\Helper\AdminLogsConstants;

/** @var \MiniOrange\AdminLogs\Block\Adminhtml\Configuration $block */
$formKey = $this->getBlockHtml('formkey');
$supportUrl = $this->getUrl('adminlogs/support/index');
$isEnabled = $this->isEnabled();

// Determine which tab should be active based on current URL
$currentUrl = $block->getRequest()->getPathInfo();
$isUpgradePage = (strpos($currentUrl, 'adminlogs/upgrade') !== false);
$isLogsViewPage = (strpos($currentUrl, 'adminlogs/logsview') !== false);
$isConfigurationPage = (strpos($currentUrl, 'adminlogs/configuration') !== false);


$showConfigurationTab = $isConfigurationPage || (!$isUpgradePage && !$isLogsViewPage);
$showLogsViewTab = $isLogsViewPage;
$showUpgradeTab = $isUpgradePage;

// Check if login/logout log limit has been reached - show banner when limit is reached
$limitCheck = $block->checkLoginLogoutLogLimit();
?>
<?php 
$activeTab = $this->getRequest()->getParam('active_tab', 'Activity Monitor Settings');
$checkDataAdded = $block->checkDataAdded();
if($checkDataAdded == null)
{ 
    $timeStamp = $this->getTimeStamp();
    $currentAdminUser = $this->getCurrentAdminUser();  
    $adminEmail = ($currentAdminUser && isset($currentAdminUser['email'])) ? $currentAdminUser['email'] : '';
    $domain = $this->getBaseUrl();
    $miniorangeAccountEmail = $this->getCustomerEmail();
    $pluginFirstPageVisit = $activeTab;
    $environmentName = $this->getEdition();
    $environmentVersion = $this->getProductVersion();
    $freeInstalledDate = $this->getCurrentDate();
    $spp_name = '';
    $autoCreateLimit = '';

    if ($adminEmail) {
        Curl::submit_to_magento_team(
            $timeStamp,
            $adminEmail,
            $domain,
            $miniorangeAccountEmail,
            $pluginFirstPageVisit,
            $environmentName,
            $environmentVersion,
            $freeInstalledDate,
            $spp_name,
            $autoCreateLimit
        );
    }

    $this->dataAdded();
}
?>
<?php if ($limitCheck['limit_reached']): ?>
<div class="upgrade-banner-wrapper">
    <div class="upgrade-banner">
        <div class="upgrade-banner-accent"></div>
        <div class="upgrade-banner-content">
            <div class="upgrade-banner-text">
                <span class="upgrade-banner-message"><?= $block->escapeHtml($limitCheck['message']) ?></span>
            </div>
            <a href="https://plugins.miniorange.com/magento-admin-logs-activity-monitor#Pricing" target="_blank" class="upgrade-banner-button">
                <span>Upgrade Now</span>
                <i class="fas fa-external-link-alt"></i>
            </a>
        </div>
    </div>
</div>
<?php endif; ?>
<div class="config-tabs-wrapper">
    <!-- Tab Navigation -->
    <div class="config-tabs-nav">
        <a href="<?= $block->escapeUrl($block->getUrl('adminlogs/configuration/index')) ?>" 
           class="config-tab-button <?= $showConfigurationTab ? 'active' : '' ?>" 
           data-tab="configuration">
            <i class="fas fa-cog"></i>
            Activity Monitor Settings
        </a>
        <a href="<?= $block->escapeUrl($block->getUrl('adminlogs/logsview/index')) ?>" 
           class="config-tab-button <?= $showLogsViewTab ? 'active' : '' ?>" 
           data-tab="logs_view">
            <i class="fas fa-list"></i>
            Admin Logs View
        </a>
        <a href="<?= $block->escapeUrl($block->getUrl('adminlogs/upgrade/index')) ?>" 
           class="config-tab-button <?= $showUpgradeTab ? 'active' : '' ?>"
           data-tab="upgrade">
            <i class="fa fa-external-link"></i>
            Upgrade
        </a>
    </div>
    
    <!-- Content Area with Sidebar -->
    <div class="config-content-wrapper">
        <!-- Main Content Area -->
        <div class="config-main-content">
            <!-- Configuration Tab -->
            <form action="<?= $block->escapeUrl($block->getFormAction()) ?>" method="post" id="config-form">
                <?= $block->getBlockHtml('formkey') ?>
                <input type="hidden" name="active_tab" id="active_tab_config" value="">
                <div class="config-tab-content <?= $showConfigurationTab ? 'active' : '' ?>" id="tab-configuration">
                    
                    <!-- White Container for Activity Monitor Settings -->
                    <div class="activity-monitor-container">
                        <!-- Main Page Header -->
                        <div class="page-header">
                            <div class="page-header-top">
                                <h2 class="page-title-settings">Activity Monitor Settings</h2>
                                <button type="button" class="setup-guide-btn" onclick="window.open('https://plugins.miniorange.com/magento-admin-logs-activity-monitor', '_blank')">
                                    <i class="fas fa-book"></i> <span class="setup-guide-text">Setup Guide</span>
                                </button>
                            </div>
                            <!-- <p class="page-subtitle">Customize which admin activities you want the system to record and monitor.</p> -->
                        </div>
                        
                        <!-- Configuration Section Block -->
                        <div class="settings-block">
                        <h2 class="block-title">
                            <span class="block-title-left">
                                <i class="fas fa-cog"></i> <?= $block->escapeHtml(__('Configuration')) ?>
                            </span>
                            <span class="premium-badge-message">
                                <span class="premium-text" style="text-decoration: none; color: #e02b27;"><?= $block->escapeHtml(__('[Limited to 10 unique users]')) ?></span>
                            </span>
                        </h2>
                        
                        <div class="config-field-group">
                            <div class="config-field-label">
                                <label for="admin_action_log">
                                    <span class="main-label"><?= $block->escapeHtml(__('Record Login/Logout Actions')) ?></span>
                                </label>
                            </div>
                            <div class="config-field-input">
                                <?php
                                $adminActionLogValue = $block->getConfigValue('miniorange/adminlogs/configuration/admin_action_log');
                                if ($adminActionLogValue === null || $adminActionLogValue === '') {
                                    $adminActionLogValue = 0;
                                }
                                ?>
                                <select id="admin_action_log" name="config[admin_action_log]" class="filter-select">
                                    <option value="1" <?= ($adminActionLogValue == 1) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Enabled')) ?></option>
                                    <option value="0" <?= ($adminActionLogValue == 0) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Disabled')) ?></option>
                                </select>
                            </div>
                        </div>

                        <div class="config-field-group">
    <div class="config-field-label">
        <label for="objects_to_log">
            <span class="main-label"><?= $block->escapeHtml(__('Select Objects to Log')) ?></span>
        </label>
    </div>
    <div class="config-field-input">
        <?php
        $configValue = $block->getConfigValue('miniorange/adminlogs/configuration/objects_to_log');
        $selectedObjects = explode(',', $configValue ?? '');
        // Default to "all" if nothing is selected
        if (empty($selectedObjects) || (count($selectedObjects) === 1 && empty($selectedObjects[0]))) {
            $selectedObjects = ['all'];
        }
        ?>
        <div class="custom-multiselect-wrapper">
            <div class="custom-multiselect-display" id="objects_to_log_display" style="pointer-events: none; opacity: 0.6; background-color: #f0f0f0;">
                <div class="selected-tags-container" id="objects_to_log_tags"></div>
                <input type="text" class="multiselect-search-input" id="objects_to_log_search" placeholder="Select Objects to Log" autocomplete="off" disabled>
                <span class="multiselect-arrow"></span>
            </div>
            <div class="custom-multiselect-dropdown" id="objects_to_log_dropdown" style="display: none;">
                <div class="multiselect-options" id="objects_to_log_options">
                    <label class="multiselect-option">
                        <input type="checkbox" value="all" <?= in_array('all', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('All Objects')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="product" <?= in_array('product', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('Product')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="customer" <?= in_array('customer', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('Customer')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="order" <?= in_array('order', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('Order')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="invoice" <?= in_array('invoice', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('Invoice')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="shipment" <?= in_array('shipment', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('Shipment')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="creditmemo" <?= in_array('creditmemo', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('Credit Memo')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="category" <?= in_array('category', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('Category')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="cms_page" <?= in_array('cms_page', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('CMS Page')) ?></span>
                    </label>
                    <label class="multiselect-option">
                        <input type="checkbox" value="cms_block" <?= in_array('cms_block', $selectedObjects) ? 'checked' : '' ?>>
                        <span><?= $block->escapeHtml(__('CMS Block')) ?></span>
                    </label>
                </div>
            </div>
        </div>
        <!-- Hidden select for form submission -->
        <select id="objects_to_log" name="config[objects_to_log][]" multiple="multiple" style="display: none;">
            <option value="all" <?= in_array('all', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('All Objects')) ?></option>
            <option value="product" <?= in_array('product', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Product')) ?></option>
            <option value="customer" <?= in_array('customer', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Customer')) ?></option>
            <option value="order" <?= in_array('order', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Order')) ?></option>
            <option value="invoice" <?= in_array('invoice', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Invoice')) ?></option>
            <option value="shipment" <?= in_array('shipment', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Shipment')) ?></option>
            <option value="creditmemo" <?= in_array('creditmemo', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Credit Memo')) ?></option>
            <option value="category" <?= in_array('category', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Category')) ?></option>
            <option value="cms_page" <?= in_array('cms_page', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('CMS Page')) ?></option>
            <option value="cms_block" <?= in_array('cms_block', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('CMS Block')) ?></option>
            <option value="tax_rule" <?= in_array('tax_rule', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Tax Rule')) ?></option>
            <option value="tax_rate" <?= in_array('tax_rate', $selectedObjects) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Tax Zone & Rate')) ?></option>
        </select>
    </div>
</div>

                    </div>

                    <!-- Logs Auto-Cleaning Section Block -->
                    <div class="settings-block">
                    <h3 class="block-title">
                        <span class="block-title-left">
                            <i class="fas fa-trash-alt"></i><?= $block->escapeHtml(__('Logs Auto-Cleaning')) ?>
                        </span>
                        <span class="premium-badge-message">
                            <a href="<?= $block->escapeUrl('https://plugins.miniorange.com/magento-admin-logs-activity-monitor#Pricing') ?>" target="_blank" class="premium-text" style="text-decoration: none; color: #e02b27;"><?= $block->escapeHtml(__('[Premium]')) ?></a>
                        </span>
                    </h3>
                    
                    <div class="config-field-group">
                        <div class="config-field-label">
                            <label for="login_attempts_auto_cleaning">
                                <span class="main-label"><?= $block->escapeHtml(__('Login Attempts Auto-Cleaning')) ?></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <select id="login_attempts_auto_cleaning" name="config[login_attempts_auto_cleaning]" class="filter-select" disabled>
                                <option value="1" <?= ($block->getConfigValue('miniorange/adminlogs/cleanup/login_attempts_auto_cleaning') == 1) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Yes')) ?></option>
                                <option value="0" <?= ($block->getConfigValue('miniorange/adminlogs/cleanup/login_attempts_auto_cleaning') == 0) ? 'selected' : '' ?>><?= $block->escapeHtml(__('No')) ?></option>
                            </select>
                        </div>
                    </div>

                    <div class="config-field-group hidden" id="login_attempts_period_group">
                        <div class="config-field-label">
                            <label for="login_attempts_period" disabled>
                                <span class="main-label"><?= $block->escapeHtml(__('Auto-Cleaning Period (in Days)')) ?> <span class="required">*</span></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <input id="login_attempts_period" name="config[login_days]" value="<?= $block->escapeHtml($block->getConfigValue('miniorange/adminlogs/cleanup/login_days')) ?>" class="admin__control-text" type="text" placeholder="Enter number of days" data-validate="{'required-entry':true, 'validate-number':true, 'validate-greater-than-zero':true}">
                            <div class="field-error" id="login_attempts_period_error" style="display:none; color:#e02b27; font-size:1.2rem; margin-top:5px;"></div>
                        </div>
                    </div>
                    
                    <div class="config-field-group">
                        <div class="config-field-label">
                            <label for="actions_log_auto_cleaning">
                                <span class="main-label"><?= $block->escapeHtml(__('Actions Log Auto-Cleaning')) ?></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <select id="actions_log_auto_cleaning" name="config[actions_log_auto_cleaning]" class="filter-select" disabled>
                                <option value="1" <?= ($block->getConfigValue('miniorange/adminlogs/cleanup/actions_log_auto_cleaning') == 1) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Yes')) ?></option>
                                <option value="0" <?= ($block->getConfigValue('miniorange/adminlogs/cleanup/actions_log_auto_cleaning') == 0) ? 'selected' : '' ?>><?= $block->escapeHtml(__('No')) ?></option>
                            </select>
                        </div>
                    </div>

                    <div class="config-field-group hidden" id="actions_log_period_group">
                        <div class="config-field-label">
                            <label for="actions_log_period">
                                <span class="main-label"><?= $block->escapeHtml(__('Auto-Cleaning Period (in Days)')) ?> <span class="required">*</span></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <input id="actions_log_period" name="config[crud_days]" value="<?= $block->escapeHtml($block->getConfigValue('miniorange/adminlogs/cleanup/crud_days')) ?>" class="admin__control-text" type="text" placeholder="Enter number of days" data-validate="{'required-entry':true, 'validate-number':true, 'validate-greater-than-zero':true}">
                            <div class="field-error" id="actions_log_period_error" style="display:none; color:#e02b27; font-size:1.2rem; margin-top:5px;"></div>
                        </div>
                    </div>
                    
                    <div class="config-field-group">
                        <div class="config-field-label">
                            <label for="role_user_log_auto_cleaning">
                                <span class="main-label"><?= $block->escapeHtml(__('Roles & User Management Log Auto-Cleaning')) ?></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <select id="role_user_log_auto_cleaning" name="config[role_user_log_auto_cleaning]" class="filter-select" disabled>
                                <option value="1" <?= ($block->getConfigValue('miniorange/adminlogs/cleanup/role_user_log_auto_cleaning') == 1) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Yes')) ?></option>
                                <option value="0" <?= ($block->getConfigValue('miniorange/adminlogs/cleanup/role_user_log_auto_cleaning') == 0) ? 'selected' : '' ?>><?= $block->escapeHtml(__('No')) ?></option>
                            </select>
                        </div>
                    </div>

                    <div class="config-field-group hidden" id="role_user_log_period_group">
                        <div class="config-field-label">
                            <label for="role_user_log_period">
                                <span class="main-label"><?= $block->escapeHtml(__('Auto-Cleaning Period (in Days)')) ?> <span class="required">*</span></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <input id="role_user_log_period" name="config[role_days]" value="<?= $block->escapeHtml($block->getConfigValue('miniorange/adminlogs/cleanup/role_days')) ?>" class="admin__control-text" type="text" placeholder="Enter number of days" data-validate="{'required-entry':true, 'validate-number':true, 'validate-greater-than-zero':true}">
                            <div class="field-error" id="role_user_log_period_error" style="display:none; color:#e02b27; font-size:1.2rem; margin-top:5px;"></div>
                        </div>
                    </div>
                </div>

                    <!-- Role & User Logging Section Block -->
                    <div class="settings-block">
                    <h3 class="block-title">
                        <span class="block-title-left">
                            <i class="fas fa-users"></i><?= $block->escapeHtml(__('Role & User Logging')) ?>
                        </span>
                        <span class="premium-badge-message">
                            <a href="<?= $block->escapeUrl('https://plugins.miniorange.com/magento-admin-logs-activity-monitor#Pricing') ?>" target="_blank" class="premium-text" style="text-decoration: none; color: #e02b27;"><?= $block->escapeHtml(__('[Premium]')) ?></a>
                        </span>
                    </h3>

                    <div class="config-field-group">
                        <div class="config-field-label">
                            <label for="log_admin_user_changes">
                                <span class="main-label"><?= $block->escapeHtml(__('Record Admin User Creation')) ?></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <select id="log_admin_user_changes" name="config[log_admin_user_changes]" class="filter-select" disabled>
                                <option value="1" <?= ($block->getConfigValue('miniorange/adminlogs/role_user_logging/log_admin_user_changes') == 1) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Enabled')) ?></option>
                                <option value="0" <?= ($block->getConfigValue('miniorange/adminlogs/role_user_logging/log_admin_user_changes') == 0) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Disabled')) ?></option>
                            </select>
                        </div>
                    </div>

                    <div class="config-field-group">
                        <div class="config-field-label">
                            <label for="log_role_changes">
                                <span class="main-label"><?= $block->escapeHtml(__('Record Role Changes')) ?></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <select id="log_role_changes" name="config[log_role_changes]" class="filter-select" disabled>
                                <option value="1" <?= ($block->getConfigValue('miniorange/adminlogs/role_user_logging/log_role_changes') == 1) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Enabled')) ?></option>
                                <option value="0" <?= ($block->getConfigValue('miniorange/adminlogs/role_user_logging/log_role_changes') == 0) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Disabled')) ?></option>
                            </select>
                        </div>
                    </div>

                    <div class="config-field-group">
                        <div class="config-field-label">
                            <label for="log_permission_changes">
                                <span class="main-label"><?= $block->escapeHtml(__('Record Permission Changes')) ?></span>
                            </label>
                        </div>
                        <div class="config-field-input">
                            <select id="log_permission_changes" name="config[log_permission_changes]" class="filter-select" disabled>
                                <option value="1" <?= ($block->getConfigValue('miniorange/adminlogs/role_user_logging/log_permission_changes') == 1) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Enabled')) ?></option>
                                <option value="0" <?= ($block->getConfigValue('miniorange/adminlogs/role_user_logging/log_permission_changes') == 0) ? 'selected' : '' ?>><?= $block->escapeHtml(__('Disabled')) ?></option>
                            </select>
                        </div>
                    </div>
                </div>
                    
                        <div class="tab-save-button">
                            <button type="submit" class="action-default primary">
                                <span>Save Configuration</span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <!-- Logs View Tab -->
            <?php
                $currentPage = $block->getCurrentPage();
                $entriesPerPage = $block->getEntriesPerPage();
                $loginLogCollection = $block->getLoginLogCollection($currentPage, $entriesPerPage);

                $totalItems = $loginLogCollection->getSize();
                $startEntry = $totalItems > 0 ? (($currentPage - 1) * $entriesPerPage) + 1 : 0;
                $endEntry = min($currentPage * $entriesPerPage, $totalItems);
            ?>
            <div class="config-tab-content <?= $showLogsViewTab ? 'active' : '' ?>" id="tab-logs_view">
                <!-- Top Controls Row -->
                <div class="logs-view-controls">
                    <div class="logs-view-controls-left">
                        <form id="entries-per-page-form" method="get" action="<?= $block->escapeUrl($block->getUrl('*/*/*', ['_current' => true])) ?>">
                            <!-- Preserve existing parameters -->
                            <input type="hidden" name="active_tab" value="logs_view" />
                            <input type="hidden" name="p" value="1" />
                            <?php
                            // Preserve logs_type if set
                            $logsType = $block->getRequest()->getParam('logs_type');
                            if ($logsType):
                            ?>
                            <input type="hidden" name="logs_type" value="<?= $block->escapeHtml($logsType) ?>" />
                            <?php endif; ?>
                            
                            <span class="show-entries-label">Show</span>
                            <select id="entries_per_page" name="entries_per_page" class="entries-select">
                                <?php
                                $currentEntriesPerPage = $block->getRequest()->getParam('entries_per_page', 10);
                                $options = [10, 25, 50, 100];
                                foreach ($options as $option):
                                ?>
                                <option value="<?= $block->escapeHtml($option) ?>" <?= ($currentEntriesPerPage == $option) ? 'selected' : '' ?>>
                                    <?= $block->escapeHtml($option) ?>
                                </option>
                                <?php endforeach; ?>
                            </select>
                            <span class="show-entries-label">entries</span>
                        </form>
                    </div>
                    <div class="logs-view-controls-right">
                        <div class="search-wrapper">
                            <svg class="search-icon" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M7.33333 12.6667C10.2789 12.6667 12.6667 10.2789 12.6667 7.33333C12.6667 4.38781 10.2789 2 7.33333 2C4.38781 2 2 4.38781 2 7.33333C2 10.2789 4.38781 12.6667 7.33333 12.6667Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 14L11.1 11.1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="text" id="search_users" class="search-input" placeholder="Search users...">
                        </div>
                    </div>
                </div>

                <!-- Filter Row -->
                <div class="logs-view-filters">
                    <div class="filter-dropdown-wrapper">
                        <form id="logs-type-form" method="get" action="<?= $block->escapeUrl($block->getUrl('*/*/*', ['_current' => true])) ?>">
                            <input type="hidden" name="active_tab" value="logs_view" />
                            <?php
                            // Preserve entries_per_page if set
                            $currentEntriesPerPage = $block->getRequest()->getParam('entries_per_page', 10);
                            if ($currentEntriesPerPage):
                            ?>
                            <input type="hidden" name="entries_per_page" value="<?= $block->escapeHtml($currentEntriesPerPage) ?>" />
                            <?php endif; ?>
                            <select id="logs_type" name="logs_type" class="filter-select">
                                <?php
                                $currentLogsType = $block->getRequest()->getParam('logs_type', 'login_logout');
                                ?>
                                <option value="login_logout" <?= ($currentLogsType == 'login_logout') ? 'selected' : '' ?>><?= $block->escapeHtml(__('Login/Logout Logs')) ?></option>
                                <option value="action" <?= ($currentLogsType == 'action') ? 'selected' : '' ?>><?= $block->escapeHtml(__('Action Logs')) ?></option>
                                <option value="user_role" <?= ($currentLogsType == 'user_role') ? 'selected' : '' ?>><?= $block->escapeHtml(__('User/Role Management Logs')) ?></option>
                                <option value="active_sessions" <?= ($currentLogsType == 'active_sessions') ? 'selected' : '' ?>><?= $block->escapeHtml(__('Active Sessions')) ?></option>
                                <option value="concurrent_sessions" <?= ($currentLogsType == 'concurrent_sessions') ? 'selected' : '' ?>><?= $block->escapeHtml(__('Concurrent Sessions')) ?></option>
                            </select>
                        </form>
                    </div>
                    <div class="filter-dropdown-wrapper" id="logs-actions-wrapper" style="<?= ($currentLogsType != 'login_logout') ? 'display: none;' : '' ?>">
                        <select id="logs_actions" class="filter-select">
                            <option value="default" selected><?= $block->escapeHtml(__('Select Action')) ?></option>
                            <option value="delete"><?= $block->escapeHtml(__('Delete')) ?></option>
                        </select>
                    </div>
                    <div class="filter-dropdown-wrapper export-dropdown-wrapper" id="export-dropdown-wrapper" style="<?= ($currentLogsType != 'login_logout') ? 'display: none;' : '' ?>">
                        <div class="export-dropdown">
                            <button type="button" class="export-dropdown-toggle filter-select" id="export-dropdown-toggle">
                                <span class="export-label"><?= $block->escapeHtml(__('Export')) ?></span>
                                <span class="export-arrow">▼</span>
                            </button>
                            <div class="export-dropdown-menu" id="export-dropdown-menu" style="display: none;">
                                <label class="export-option">
                                    <input type="radio" name="export_format_option" value="csv" class="export-radio">
                                    <span class="export-option-label"><?= $block->escapeHtml(__('CSV')) ?></span>
                                </label>
                                <label class="export-option">
                                    <input type="radio" name="export_format_option" value="excel" class="export-radio">
                                    <span class="export-option-label"><?= $block->escapeHtml(__('Excel')) ?></span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mass Action Form -->
                <form id="mass_action_form" method="post" action="<?= $block->escapeUrl($block->getUrl('adminlogs/logs/massAction')) ?>" style="display: none;">
                    <?= $block->getBlockHtml('formkey') ?>
                    <input type="hidden" name="log_type" id="log_type" value="">
                    <input type="hidden" name="action_type" id="action_type" value="">
                    <input type="hidden" name="selected_ids" id="selected_ids" value="">
                </form>

                <!-- Export Form -->
                <form id="export_form" method="post" action="" style="display: none;">
                    <?= $block->getBlockHtml('formkey') ?>
                    <?php
                    $currentLogType = $block->getRequest()->getParam('logs_type', 'login_logout');
                    ?>
                    <input type="hidden" name="log_type" id="export_log_type" value="<?= $block->escapeHtml($currentLogType) ?>">
                    <input type="hidden" name="export_format" id="export_format" value="">
                </form>

                <!-- Confirmation Dialog -->
                <div id="mass_action_confirm_dialog" style="display: none;">
                    <div class="mass-action-dialog-overlay"></div>
                    <div class="mass-action-dialog-content">
                        <div class="mass-action-dialog-header">
                            <h3><?= $block->escapeHtml(__('Confirmation')) ?></h3>
                        </div>
                        <div class="mass-action-dialog-body">
                            <p><?= $block->escapeHtml(__('Are you sure you want to delete the selected items?')) ?></p>
                        </div>
                        <div class="mass-action-dialog-footer">
                            <button type="button" id="mass_action_confirm_btn" class="action-primary"><?= $block->escapeHtml(__('Confirm')) ?></button>
                            <button type="button" id="mass_action_cancel_btn" class="action-secondary"><?= $block->escapeHtml(__('Cancel')) ?></button>
                        </div>
                    </div>
                </div>

                <!-- Session Details Modal -->
                <div id="session_details_modal" style="display: none;">
                    <div class="session-modal-overlay"></div>
                    <div class="session-modal-content">
                        <div class="session-modal-header">
                            <h2 class="session-modal-title"><?= $block->escapeHtml(__('Session Details')) ?></h2>
                            <button type="button" class="session-modal-close">×</button>
                        </div>
                        <div class="session-modal-body">
                            <div class="session-details-loading" style="text-align: center; padding: 20px; display: none;">
                                <span><?= $block->escapeHtml(__('Loading session details...')) ?></span>
                            </div>
                            <div class="session-details-error" style="display: none; color: #e02b27; padding: 20px; text-align: center;"></div>
                            <div class="session-details-content" style="display: none;">
                                <div class="logs-table-wrapper">
                                    <table class="data-grid logs-data-table">
                                        <thead>
                                            <tr>
                                                <th class="sortable" data-column="ip_address"><?= $block->escapeHtml(__('IP Address')) ?></th>
                                                <th class="sortable" data-column="location"><?= $block->escapeHtml(__('Location')) ?></th>
                                                <th class="sortable" data-column="login_time"><?= $block->escapeHtml(__('Login Time')) ?></th>
                                                <th class="sortable" data-column="last_activity"><?= $block->escapeHtml(__('Last Activity')) ?></th>
                                                <th><?= $block->escapeHtml(__('Action')) ?></th>
                                            </tr>
                                        </thead>
                                        <tbody class="session-details-tbody">
                                            <!-- Session details will be populated here via JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Table Container -->
                <div id="logs-tables-container">
                    <!-- Login/Logout Logs Table -->
                    <div id="table-login_logout" class="logs-table-content" style="display: none;">
                        <div class="logs-table-wrapper">
                            <table class="data-grid logs-data-table">
                                <thead>
                                    <tr>
                                        <th class="data-grid-checkbox-cell">
                                            <input type="checkbox" id="select-all-login-logout" />
                                        </th>
                                        <th class="sortable" data-column="logged_in_at">Logged In At</th>
                                        <th class="sortable" data-column="username">Username</th>
                                        <th class="sortable" data-column="full_name">Full Name</th>
                                        <th class="sortable" data-column="type">Type</th>
                                        <th class="sortable" data-column="status">Status</th>
                                        <th class="sortable" data-column="location">Location</th>
                                        <th class="sortable" data-column="ip_address">IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="login-logout-tbody">
                                    <?php
                                    // Fetch all records for client-side pagination
                                    $loginLogsCollection = $block->getLoginLogCollection(0, 0);
                                    $loginLogsCollection->load();
                                    if ($loginLogsCollection->getSize() > 0):
                                        foreach ($loginLogsCollection as $log):
                                            $loggedAt = $log->getLoggedAt();
                                            $username = $block->escapeHtml($log->getUsername());
                                            $fullName = $block->escapeHtml($log->getFullName() ?: 'Unknown');
                                            $type = $block->escapeHtml($log->getType() ?: 'N/A');
                                            $status = $block->escapeHtml($log->getStatus());
                                            $location = $block->escapeHtml($log->getLocation() ?: '');
                                            $ipAddress = $block->escapeHtml($log->getIpAddress());
                                            
                                            // Determine status class
                                            $statusClass = 'status-failed';
                                            if (strtolower($status) === 'success') {
                                                $statusClass = 'status-success';
                                            } elseif (strtolower($status) === 'failed' || strtolower($status) === 'failure') {
                                                $statusClass = 'status-failed';
                                            }
                                            
                                            // Format date
                                            $formattedDate = '';
                                            if ($loggedAt) {
                                                try {
                                                    $date = new \DateTime($loggedAt);
                                                    $formattedDate = $date->format('Y-m-d H:i:s');
                                                } catch (\Exception $e) {
                                                    $formattedDate = $loggedAt;
                                                }
                                            }
                                    ?>
                                    <tr>
                                    <td class="data-grid-checkbox-cell">
                                            <input type="checkbox" class="row-checkbox" value="<?= $block->escapeHtmlAttr($log->getLogId()) ?>" />
                                        </td>
                                        <td><?= $block->escapeHtml($formattedDate) ?></td>
                                        <td><?= $block->escapeHtml($username) ?></td>
                                        <td><?= $block->escapeHtml($fullName) ?></td>
                                        <td><?= $block->escapeHtml($type) ?></td>
                                        <td>
                                            <span class="status-badge <?= $block->escapeHtmlAttr($statusClass) ?>">
                                                <?= $block->escapeHtml($status) ?></span></td>
                                        <td><?= $block->escapeHtml($location) ?></td>
                                        <td><?= $block->escapeHtml($ipAddress) ?></td>
                                    </tr>
                                    <?php
                                        endforeach;
                                    else:
                                    ?>
                                    <tr>
                                        <td colspan="8" class="empty-text">
                                            <?= $block->escapeHtml(__('No login/logout logs found.')) ?>
                                        </td>
                                    </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                            
                            <!-- Table Footer with Pagination -->
                            <div class="logs-table-footer">
                                <div class="footer-left">
                                    <span id="login-logout-entries-info">Showing 1 to 1 of 1 entries</span>
                                </div>
                                <div class="footer-right">
                                    <button type="button" class="action-default pagination-btn" id="login-logout-prev">
                                        <span>Previous</span>
                                    </button>
                                    <button type="button" class="action-default primary pagination-btn" id="login-logout-next">
                                        <span>Next</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Logs Table -->
                    <div id="table-action" class="logs-table-content" style="display: none;">
                        <div class="logs-table-wrapper">
                            <table class="data-grid logs-data-table">
                                <thead>
                                    <tr>
                                        <th class="data-grid-checkbox-cell">
                                            <input type="checkbox" id="select-all-action" />
                                        </th>
                                        <th class="sortable" data-column="logged_in_at">Logged In At</th>
                                        <th class="sortable" data-column="username">Username</th>
                                        <th class="sortable" data-column="entity_type">Entity Type</th>
                                        <th class="sortable" data-column="entity_id">Entity ID</th>
                                        <th class="sortable" data-column="entity_label">Entity Label</th>
                                        <th class="sortable" data-column="action">Action</th>
                                        <th class="sortable" data-column="ip_address">IP Address</th>
                                        <th class="sortable" data-column="changes">Changes</th>
                                    </tr>
                                </thead>
                                <tbody id="action-tbody">
                                    
                                    <tr>
                                        <td colspan="9" class="upgrade-message">
                                            <?= $block->escapeHtml(__('Upgrade to ')) ?><strong><a href="<?= $block->escapeUrl('https://plugins.miniorange.com/magento-admin-logs-activity-monitor#Pricing') ?>" target="_blank" style="color: #eb5202; text-decoration: none;"><?= $block->escapeHtml(__('Premium')) ?></a></strong><?= $block->escapeHtml(__(' to enable Admin Activity Logging.')) ?>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Table Footer with Pagination -->
                            <div class="logs-table-footer">
                                <div class="footer-left">
                                    <span id="action-entries-info">Showing 1 to 1 of 1 entries</span>
                                </div>
                                <div class="footer-right">
                                    <button type="button" class="action-default pagination-btn" id="action-prev">
                                        <span>Previous</span>
                                    </button>
                                    <button type="button" class="action-default primary pagination-btn" id="action-next">
                                        <span>Next</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User/Role Management Logs Table -->
                    <div id="table-user_role" class="logs-table-content" style="display: none;">
                        <div class="logs-table-wrapper">
                            <table class="data-grid logs-data-table">
                                <thead>
                                    <tr>
                                        <th class="data-grid-checkbox-cell">
                                            <input type="checkbox" id="select-all-role-logs" />
                                        </th>
                                        <th class="sortable" data-column="logged_in_at">Logged In At</th>
                                        <th class="sortable" data-column="username">Username</th>
                                        <th class="sortable" data-column="log_type">Log Type</th>
                                        <th class="sortable" data-column="action">Action</th>
                                        <th class="sortable" data-column="target_name">Target Name</th>
                                        <th class="sortable" data-column="changes">Changes</th>
                                        <th class="sortable" data-column="ip_address">IP Address</th>
                                    </tr>
                                </thead>
                                <tbody id="action-tbody">
                                    
                                    <tr>
                                        <td colspan="9" class="upgrade-message">
                                            <?= $block->escapeHtml(__('Upgrade to ')) ?><strong><a href="<?= $block->escapeUrl('https://plugins.miniorange.com/magento-admin-logs-activity-monitor#Pricing') ?>" target="_blank" style="color: #eb5202; text-decoration: none;"><?= $block->escapeHtml(__('Premium')) ?></a></strong><?= $block->escapeHtml(__(' to enable Admin Activity Logging.')) ?>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <!-- Table Footer with Pagination -->
                            <div class="logs-table-footer">
                                <div class="footer-left">
                                    <span id="role-logs-entries-info">Showing 1 to 1 of 1 entries</span>
                                </div>
                                <div class="footer-right">
                                    <button type="button" class="action-default pagination-btn" id="role-logs-prev">
                                        <span>Previous</span>
                                    </button>
                                    <button type="button" class="action-default primary pagination-btn" id="role-logs-next">
                                        <span>Next</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Active Sessions Table -->
                    <div id="table-active_sessions" class="logs-table-content" style="display: none;">
                        <div class="logs-table-wrapper">
                            <table class="data-grid logs-data-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="id">ID</th>
                                        <th class="sortable" data-column="logged_in_at">Logged In At</th>
                                        <th class="sortable" data-column="username">Username</th>
                                        <th class="sortable" data-column="full_name">Full Name</th>
                                        <th class="sortable" data-column="ip_address">IP Address</th>
                                        <th class="sortable" data-column="location">Location</th>
                                        <th class="sortable" data-column="recent_activity">Recent Activity</th>
                                    </tr>
                                </thead>
                                <tbody id="active-sessions-tbody">
                                    <?php
                                    // Fetch all records using DataProvider's getData method
                                    $activeSessionsDataProvider = $block->getActiveSessionsDataProvider();
                                    $activeSessionsData = $activeSessionsDataProvider->getData();
                                    if (!empty($activeSessionsData['items'])):
                                        $rowIndex = 1;
                                        foreach ($activeSessionsData['items'] as $item):
                                            $loggedAt = isset($item['login_time']) ? $item['login_time'] : (isset($item['created_at']) ? $item['created_at'] : '');
                                            $username = $block->escapeHtml(isset($item['user_name']) ? $item['user_name'] : '');
                                            $fullName = $block->escapeHtml(isset($item['full_name']) ? $item['full_name'] : (isset($item['name']) ? $item['name'] : 'Unknown'));
                                            $ipAddress = $block->escapeHtml(isset($item['ip']) ? $item['ip'] : '');
                                            $location = $block->escapeHtml(isset($item['location']) ? $item['location'] : 'Unknown');
                                            $recentActivity = $block->escapeHtml(isset($item['last_activity']) ? $item['last_activity'] : '');
                                            // Use id (primary key) for checkbox value to match UI component indexField
                                            $recordId = isset($item['id']) ? $item['id'] : '';
                                            
                                            // Format date
                                            $formattedDate = '';
                                            if ($loggedAt) {
                                                try {
                                                    $date = new \DateTime($loggedAt);
                                                    $formattedDate = $date->format('Y-m-d H:i:s');
                                                } catch (\Exception $e) {
                                                    $formattedDate = $loggedAt;
                                                }
                                            }
                                            
                                            // Format recent activity date
                                            $formattedRecentActivity = '';
                                            if ($recentActivity) {
                                                try {
                                                    $date = new \DateTime($recentActivity);
                                                    $formattedRecentActivity = $date->format('Y-m-d H:i:s');
                                                } catch (\Exception $e) {
                                                    $formattedRecentActivity = $recentActivity;
                                                }
                                            }
                                    ?>
                                    <tr>
                                        <td><?= $block->escapeHtml($rowIndex) ?></td>
                                        <td><?= $block->escapeHtml($formattedDate) ?></td>
                                        <td><?= $block->escapeHtml($username) ?></td>
                                        <td><?= $block->escapeHtml($fullName) ?></td>
                                        <td><?= $block->escapeHtml($ipAddress) ?></td>
                                        <td><?= $block->escapeHtml($location) ?></td>
                                        <td><?= $block->escapeHtml($formattedRecentActivity) ?></td>
                                    </tr>
                                    <?php
                                            $rowIndex++;
                                        endforeach;
                                    else:
                                    ?>
                                    <tr>
                                        <td colspan="7" class="empty-text">
                                            <?= $block->escapeHtml(__('No active sessions found.')) ?>
                                        </td>
                                    </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                            
                            <!-- Table Footer with Pagination -->
                            <div class="logs-table-footer">
                                <div class="footer-left">
                                    <span id="active-sessions-entries-info">Showing 1 to 1 of 1 entries</span>
                                </div>
                                <div class="footer-right">
                                    <button type="button" class="action-default pagination-btn" id="active-sessions-prev">
                                        <span>Previous</span>
                                    </button>
                                    <button type="button" class="action-default primary pagination-btn" id="active-sessions-next">
                                        <span>Next</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Concurrent Sessions Table -->
                    <div id="table-concurrent_sessions" class="logs-table-content" style="display: none;">
                        <div class="logs-table-wrapper">
                            <table class="data-grid logs-data-table">
                                <thead>
                                    <tr>
                                        <th class="sortable" data-column="id">ID</th>
                                        <th class="sortable" data-column="username">Username</th>
                                        <th class="sortable" data-column="full_name">Full Name</th>
                                        <th class="sortable" data-column="active_sessions">Active Sessions</th>
                                        <th>View</th>
                                    </tr>
                                </thead>
                                <tbody id="concurrent-sessions-tbody">
                                    <?php
                                    // Fetch all records using DataProvider's getData method
                                    $concurrentSessionsDataProvider = $block->getConcurrentSessionsDataProvider();
                                    $concurrentSessionsData = $concurrentSessionsDataProvider->getData();
                                    if (!empty($concurrentSessionsData['items'])):
                                        $rowIndex = 1;
                                        foreach ($concurrentSessionsData['items'] as $item):
                                            $username = $block->escapeHtml(isset($item['username']) ? $item['username'] : (isset($item['user_name']) ? $item['user_name'] : ''));
                                            $fullName = $block->escapeHtml(isset($item['name']) ? $item['name'] : 'Unknown');
                                            $activeSessions = isset($item['session_count']) ? (int)$item['session_count'] : 0;
                                            $userId = isset($item['user_id']) ? $item['user_id'] : (isset($item['id']) ? $item['id'] : '');
                                    ?>
                                    <tr class="concurrent-session-row" data-user-id="<?= $block->escapeHtml($userId) ?>">
                                        <td><?= $block->escapeHtml($rowIndex) ?></td>
                                        <td><?= $block->escapeHtml($username) ?></td>
                                        <td><?= $block->escapeHtml($fullName) ?></td>
                                        <td>
                                            <span class="session-count" data-user-id="<?= $block->escapeHtml($userId) ?>">
                                                <?= $block->escapeHtml($activeSessions) ?>
                                            </span>
                                        </td>
                                        <td>
                                            <button type="button" class="action-default view-session-btn" data-user-id="<?= $block->escapeHtml($userId) ?>" title="View Session Details">
                                                View
                                            </button>
                                        </td>
                                    </tr>
                                    <?php
                                            $rowIndex++;
                                        endforeach;
                                    else:
                                    ?>
                                    <tr>
                                        <td colspan="5" class="empty-text">
                                            <?= $block->escapeHtml(__('No concurrent sessions found.')) ?>
                                        </td>
                                    </tr>
                                    <?php endif; ?>
                                </tbody>
                            </table>
                            
                            <!-- Table Footer with Pagination -->
                            <div class="logs-table-footer">
                                <div class="footer-left">
                                    <span id="concurrent-sessions-entries-info">Showing 1 to 1 of 1 entries</span>
                                </div>
                                <div class="footer-right">
                                    <button type="button" class="action-default pagination-btn" id="concurrent-sessions-prev">
                                        <span>Previous</span>
                                    </button>
                                    <button type="button" class="action-default primary pagination-btn" id="concurrent-sessions-next">
                                        <span>Next</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Upgrade Tab -->
            <div class="config-tab-content <?= $showUpgradeTab ? 'active' : '' ?>" id="tab-upgrade">
                <?php
                // Upgrade tab data
                $viewModel = null;
                if (method_exists($block, 'getViewModel')) {
                    $viewModel = $block->getViewModel();
                }

                // Helper function to get view file URL
                $getViewFileUrl = function($file) use ($viewModel, $block) {
                    // Try viewModel first if available
                    if ($viewModel && method_exists($viewModel, 'getViewFileUrl')) {
                        try {
                            $url = $viewModel->getViewFileUrl($file);
                            if (!empty($url)) {
                                return $url;
                            }
                        } catch (\Exception $e) {
                            // Fall through to block method
                        }
                    }
                    // Use block's getViewFileUrl method (standard Magento way)
                    return $block->getViewFileUrl($file);
                };

                $products = [
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/idp_upgrade.png'),
                        'alt' => '',
                        'title' => 'SAML IDP',
                        'description' => 'Login into any third party applications using Magento credentials.',
                        'link' => 'https://commercemarketplace.adobe.com/miniorange-inc-idpsaml.html'
                    ],
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/twofa_upgrade.png'),
                        'alt' => 'Two-Factor Authentication',
                        'title' => 'Two-Factor Authentication',
                        'description' => 'Add a second layer of authentication to secure your Magento store frontend & backend accounts.',
                        'link' => 'https://commercemarketplace.adobe.com/miniorange-inc-miniorange-2fa.html'
                    ],
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/scim_upgrade.png'),
                        'alt' => 'Scim User Provisioning',
                        'title' => 'User Provisioning & Sync',
                        'description' => 'Automate real-time two-way user sync, including creation, updates, and deletions, between your applications and Magento.',
                        'link' => 'https://commercemarketplace.adobe.com/miniorange-inc-scim.html'
                    ],
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/otp_upgrade.png'),
                        'alt' => 'Mobile Login',
                        'title' => 'Mobile Login',
                        'description' => 'Log in to Magento store using mobile number/email — no password required.',
                        'link' => 'https://commercemarketplace.adobe.com/miniorange-inc-otp-verification.html'
                    ],
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/ldap_upgrade.png'),
                        'alt' => 'LDAP Login',
                        'title' => 'LDAP / Active Directory Login Integration',
                        'description' => 'Log in to Magento using LDAP/AD credentials from Active Directory, OpenLDAP, OpenDS, FreeIPA, Synology, and more.',
                        'link' => 'https://commercemarketplace.adobe.com/miniorange-inc-miniorange-ldap.html'
                    ],
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/google_upgrade.png'),
                        'alt' => 'Google One Tap Login',
                        'title' => 'Google One Tap Login',
                        'description' => 'One Click sign in or register on your Magento store using Google Account credentials.',
                        'link' => 'https://commercemarketplace.adobe.com/miniorange-inc-google-one-tap-login.html'
                    ],
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/security_upgrade.png'),
                        'alt' => 'Security Suite',
                        'title' => 'Security Suite',
                        'description' => 'Secure your Magento store with robust security tools.',
                        'link' => 'https://plugins.miniorange.com/magento-2-security-suite-extension'
                    ],
                    [
                        'image' => $getViewFileUrl('MiniOrange_AdminLogs::images/social_upgrade.png'),
                        'alt' => 'Social Login & Share',
                        'title' => 'Social Login & Share',
                        'description' => 'Log in to Magento using social login credentials, including Facebook, Instagram, Google, Twitter, LinkedIn, and more.',
                        'link' => 'https://commercemarketplace.adobe.com/miniorange-inc-miniorange-social-login.html'
                    ],
                ];

                // Get plan level and name
                $get_plan_level = null;
                if ($viewModel && method_exists($viewModel, 'get_versi')) {
                    $get_plan_level = $viewModel->get_versi();
                }
                if($get_plan_level == 4){
                    $plan_name = 'Admin Activity Logs Trial Extension';
                }elseif($get_plan_level == 3){
                    $plan_name = 'Admin Activity Logs Enterprise Extension';
                }else{ 
                    $plan_name = 'Admin Activity Logs Extension';
                }

                // Get current version
                $currentVersion = '';
                if ($viewModel && method_exists($viewModel, 'getCurrentVersion')) {
                    $currentVersion = $viewModel->getCurrentVersion();
                } else {
                    $currentVersion = 'v1.0.0';
                }
                ?>
                <!-- Upgrade Tab Content -->
                <div class="main-content-upgrade">
                    <div class="container">
                        <div class="main-panel_upgrade background_gray">
                            <div class="panel-content">
                                <!-- Ultra Simple Upgrade Banner -->
                                <div class="upgrade-banner">
                                    <div class="plan-info">
                                        <div class="plan-status">Current Plan</div>
                                        <div class="panel-title_report"><?php echo $block->escapeHtml($plan_name); ?> <span
                                                class="plan-version">Version <?php echo $block->escapeHtml($currentVersion); ?></span>
                                        </div>
                                    </div>
                                    <span>
                                        <a href="https://plugins.miniorange.com/magento-admin-logs-activity-monitor#Pricing"
                                           target="_blank" class="upgrade-banner-button" style="float: right;font-size:1.4rem">
                                            <i class="fas fa-arrow-circle-up"></i>
                                            Click Here to Upgrade
                                        </a>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Related Products -->
                        <div class="main-panel_upgrade">
                            <div class="panel-header">
                                <div class="panel-title-container">
                                    <h2 class="panel-title">Related Products</h2>
                                    <p class="panel-subtitle">Enhance your Magento store with our complementary extensions</p>
                                </div>
                                <div class="panel-actions">
                                    <a href="https://plugins.miniorange.com/magento" target="_blank" class="btn btn-outline">
                                        <i class="fas fa-th-large"></i>
                                        View All Products
                                    </a>
                                </div>
                            </div>

                            <div class="panel-content">
                                <div class="products-grid">
                                    <?php foreach ($products as $product): ?>
                                        <div class="product-card">
                                            <div class="product-image">
                                                <img src="<?php echo $block->escapeUrl($product['image']); ?>" loading="lazy" alt="<?php echo $block->escapeHtmlAttr($product['alt']); ?>">
                                            </div>
                                            <div class="product-details">
                                                <h3 class="product-title"><?php echo $block->escapeHtml($product['title']); ?></h3>
                                                <p class="product-description"><?php echo $block->escapeHtml($product['description']); ?></p>
                                                <div class="product-actions">
                                                    <a href="<?php echo $block->escapeUrl($product['link']); ?>" target="_blank"
                                                       class="btn btn-primary position">View Details</a>
                                                </div>
                                            </div>
                                        </div>
                                    <?php endforeach; ?>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Support Chat Widget (Popup) -->
    <div id="support-chat-widget">
        <!-- Support Form (Hidden by default) -->
        <div id="support-form-container" class="support-form-hidden">
            <div class="support-form-header">
                <span>miniOrange Support</span>
                <button id="close-support-form" class="close-support-btn">×</button>
            </div>
            <div class="support-form-content">
                <form id="support-popup-form" action="<?= $block->escapeUrl($supportUrl) ?>" method="post" target="_self">
                    <?= $block->getBlockHtml('formkey') ?>
                    
                    <div class="support-form-field">
                        <label for="popup_support_email">Contact E-mail</label>
                        <input type="email" id="popup_support_email" placeholder="Enter valid email" name="support_email" required />
                    </div>

                    <div class="support-form-field">
                        <label for="popup_support_phone">Contact Phone</label>
                        <input type="tel" id="popup_support_phone" placeholder="Enter valid phone number with country code" name="support_phone" required />
                    </div>

                    <div class="support-form-field">
                        <label for="popup_support_query">How can we help you?</label>
                        <textarea id="popup_support_query" name="support_message" placeholder="Enter your query here. We will get back to you as soon as possible via email." rows="4" required></textarea>
                    </div>

                    <div class="support-form-field">
                        <button type="submit" name="send_query" value="Submit Query" class="support-submit-btn">
                            Submit
                        </button>
                    </div>
                </form>
                
                <!-- Success Message -->
                <div id="support-success-message" style="display: none;">
                    <div class="support-success-icon">
                        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41L9 16.17z" fill="#ffffff"/>
                        </svg>
                    </div>
                    <div class="support-success-text">
                        <p>Thanks for your inquiry.</p>
                        <p>We will get back shortly via email.</p>
                        <p>If you don't hear from us within 24 hours,</p>
                        <p>please send a follow-up email to</p>
                        <p><strong>magentosupport@xecurify.com</strong>.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Support Chat Button -->
        <div id="support-chat-button">
            <img src="<?= $block->escapeUrl($block->getViewFileUrl('MiniOrange_AdminLogs::images/mo.png')) ?>" alt="Support" />
            <!-- Speech Bubble -->
            <div id="support-speech-bubble" class="support-speech-bubble">
                <center>Hello there! <br></center>
                Need Help? Drop us an email!
            </div>
        </div>
    </div>
</div>

<!-- Changes JSON Modal -->
<div id="changes-json-modal" class="changes-modal-overlay" style="display: none;">
    <div class="changes-modal-content">
        <div class="changes-modal-header">
            <h3>Changes Details</h3>
            <button type="button" class="changes-modal-close" aria-label="Close">&times;</button>
        </div>
        <div class="changes-modal-body">
            <pre id="changes-json-content" class="changes-json-display"></pre>
        </div>
    </div>
</div>

<!-- Session Details Popup -->
<div id="session-details-popup" class="session-details-popup" style="display: none;">
    <div class="session-details-content">
        <div class="session-details-header">
            <h3>Session Details</h3>
            <button type="button" class="session-details-close" aria-label="Close">&times;</button>
        </div>
        <div class="session-details-body">
            <div id="session-details-loading" style="display: none; text-align: center; padding: 20px;">
                <span>Loading session details...</span>
            </div>
            <div id="session-details-error" style="display: none; text-align: center; padding: 20px; color: #e02b27;">
                <span></span>
            </div>
            <table id="session-details-table" class="session-details-table" style="display: none; width: 100%; border-collapse: collapse;">
                <thead>
                    <tr>
                        <th style="padding: 12px; border: 1px solid #ddd; background-color: #f5f5f5; text-align: left;">IP Address</th>
                        <th style="padding: 12px; border: 1px solid #ddd; background-color: #f5f5f5; text-align: left;">Location</th>
                        <th style="padding: 12px; border: 1px solid #ddd; background-color: #f5f5f5; text-align: left;">Login Time</th>
                        <th style="padding: 12px; border: 1px solid #ddd; background-color: #f5f5f5; text-align: left;">Last Activity</th>
                        <th style="padding: 12px; border: 1px solid #ddd; background-color: #f5f5f5; text-align: left;">Action</th>
                    </tr>
                </thead>
                <tbody id="session-details-tbody">
                    <!-- Session rows will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
/* Table Container */
.pagination-btn.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
}

.logs-table-wrapper {
    background-color: #fff;
    border: 1px solid #e3e3e3;
    border-radius: 3px;
    margin-top: 20px;
}

/* Table Styling */
.logs-data-table {
    width: 100%;
    border-collapse: collapse;
    background-color: #fff;
    font-size: 13px;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

/* Table Header */
.logs-data-table thead tr {
    background-color: #e8e8e8;
    border-bottom: 1px solid #d0d0d0;
}

.logs-data-table thead th {
    padding: 12px 15px;
    text-align: left;
    font-weight: 600;
    color: #333;
    font-size: 13px;
    border-bottom: 1px solid #d0d0d0;
    white-space: nowrap;
}

/* Checkbox Cell */
.logs-data-table .data-grid-checkbox-cell {
    width: 50px;
    text-align: center;
    padding: 12px 15px;
}

.logs-data-table .data-grid-checkbox-cell input[type="checkbox"] {
    cursor: pointer;
    /* width: 16px; */
    height: 16px;
}

/* Table Body */
.logs-data-table tbody tr {
    background-color: #fff;
    border-bottom: 1px solid #e3e3e3;
    transition: background-color 0.2s ease;
}

.logs-data-table tbody tr:hover {
    background-color: #f9f9f9;
}

.logs-data-table tbody tr:last-child {
    border-bottom: none;
}

.logs-data-table tbody td {
    padding: 12px 15px;
    color: #333;
    font-size: 13px;
    vertical-align: middle;
}

.logs-data-table tbody td:last-child {
    border-right: none;
}

.logs-data-table .empty-text {
    text-align: center;
    padding: 30px 20px;
    color: #999;
    font-style: italic;
}

.logs-data-table .upgrade-message {
    text-align: center;
    padding: 20px 15px;
    color: #514943;
    font-size: 15px;
    font-weight: 500;
    font-style: normal;
    background: linear-gradient(to bottom, #fafafa 0%, #f5f5f5 100%);
    border: 1px solid #e3e3e3;
    border-left: 4px solid #eb5202;
    border-radius: 4px;
    margin: 15px 0;
    line-height: 1.7;
    letter-spacing: 0.1px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    position: relative;
}

.logs-data-table .upgrade-message::before {
    display: inline-block;
    margin-right: 8px;
    font-size: 18px;
    vertical-align: middle;
}

.logs-data-table .upgrade-message strong {
    color: #eb5202;
    font-weight: 600;
}

/* Footer Styling */
.logs-table-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px 20px;
    background-color: #fafafa;
    border-top: 1px solid #e3e3e3;
    border-radius: 0 0 3px 3px;
}

.logs-table-footer .footer-left {
    color: #666;
    font-size: 13px;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

.logs-table-footer .footer-right {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Pagination Buttons */
.logs-table-footer .pagination-btn {
    padding: 7px 14px;
    cursor: pointer;
    border: 1px solid #ccc;
    background-color: #fff;
    color: #333;
    font-size: 13px;
    font-weight: 500;
    border-radius: 3px;
    transition: all 0.2s ease;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

.logs-table-footer .pagination-btn:hover:not(:disabled) {
    background-color: #f5f5f5;
    border-color: #adadad;
}

.logs-table-footer .pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #f5f5f5;
    color: #999;
}

.logs-table-footer .pagination-btn.primary {
    padding: 7px 14px;
    background-color: #ff6a3d;
    color: #fff;
    border-color: #ff6a3d;
}

.logs-table-footer .pagination-btn.primary:hover:not(:disabled) {
    background-color: #ff5722;
    border-color: #ff5722;
}

.logs-table-footer .pagination-btn.primary:disabled {
    background-color: #ffb299;
    border-color: #ffb299;
    color: #fff;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .logs-table-footer {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
    }
    
    .logs-table-footer .footer-right {
        width: 100%;
        justify-content: space-between;
    }
}

/* White Container for Activity Monitor Settings */
.activity-monitor-container {
    margin-left: -24px;
    margin-right: -10px;
    background-color:#fff;
    border:0.5px #e3e3e3;
    border-radius: 4px;
    /* padding: 30px; */
    margin-bottom: 20px;
}

/* Page Header Styles */
.page-header {
    margin-bottom: -12px;
    padding-left: 0;
    width: 100%;
    box-sizing: border-box;
}

.page-header-top {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
    padding-left: 20px;
}

.page-title {
    font-size: 2.7rem;
    /* font-weight: 500; */
    font-family: 'Segoe UI';
    padding: 0px 0px 61px 42px;
    /* border-bottom: 1px solid #ddd; */
}

.page-title-settings {
    margin-left: -64px;
    font-size: 2.3rem;
    font-weight: 700;
    font-family: 'Segoe UI';
    padding: 2px 0px 18px 65px;
    /* border-bottom: 1px solid #ddd; */
}

.setup-guide-btn {
    margin-top: -35px;
    margin-right: -17px;
    display: inline-flex;
    align-items: center;
    /* gap: 8px; */
    padding: 9px 18px;
    background-color: #eb5202;
    color: #ffffff;
    border: none;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 400;
    font-family : -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.setup-guide-btn:hover {
    background-color: #eb5202;
    color: #ffffff;
}

.setup-guide-btn:hover .setup-guide-text,
.setup-guide-btn:hover .fas,
.setup-guide-btn:hover i {
    color: #ffffff;
}

.setup-guide-btn:active {
    background-color: #eb5202;
    color: #ffffff;
}

.setup-guide-btn:active .setup-guide-text,
.setup-guide-btn:active .fas,
.setup-guide-btn:active i {
    color: #ffffff;
}

.setup-guide-icon {
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    color: #ffffff;
}

.setup-guide-text {
    text-align: center;
    margin-left: 5px;
    white-space: nowrap;
    font-size: 16px;
    font-weight: 400;
    font-family : -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    color: #ffffff;
}

.setup-guide-btn .fas,
.setup-guide-btn i {
    color: #ffffff;
}

.support-submit-btn {
    background-color: black;
    color: #ffffff;
    border: 1px solid black;
    border-radius: 4px;
    font-size: 16px;
    font-weight: 400;
    width: 259px;
    height: 36px;
    font-family : -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

.support-submit-btn:hover {
    background-color: black;
    color: #ffffff;
    border: 1px solid black;
}

.support-submit-btn:active {
    background-color: black;
    color: #ffffff;
    border: 1px solid black;
}

.page-subtitle {
    font-size: 14px;
    color: #666;
    margin: 0;
    line-height: 1.5;
    padding-left: 20px;
}

.page-header hr {
    width: 100%;
    margin: 0;
    border: none;
    border-top: 1px solid #ddd;
    padding: 0;
    display: block;
    box-sizing: border-box;
    position: relative;
    left: 0;
    right: 0;
}

/* Settings Block Styles (Grey Boxes) */
.settings-block {
    margin-left: 22px;
    margin-right: 16px;
    background-color: #ffffff;
    border: 1px solid #e3e3e3;
    border-radius: 4px;
    padding: 15px;
    margin-bottom: 15px;
    max-width: 100%;
}

.block-title {
    background-color: #f5f5f5;
    font-size: 1.9rem;
    font-weight: 600;
    font-family: 'Segoe UI';
    color: #1d1d1d;
    margin: -15px -15px 15px -15px;
    padding: 15px 15px 12px 15px;
    border-bottom: 1px solid #e3e3e3;
    display: flex;
    align-items: center;
    gap: 8px;
    box-sizing: border-box;
}

/* Only apply space-between when premium badge is present */
.block-title:has(.premium-badge-message) {
    justify-content: space-between;
}

.block-title-left {
    display: flex;
    align-items: center;
    gap: 8px;
}

/* Premium Badge Message - Separate CSS block that doesn't affect headings */
.premium-badge-message {
    margin-right: 825px;
    padding : 0px 0px 0px 10px;
    font-size: 1.3rem;
    font-weight: 0;
    color: #666;
    font-family: 'Segoe UI', 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    line-height: 1.5;
    white-space: nowrap;
    margin-left: auto;
}

.premium-badge-message .premium-asterisk {
    color: #e02b27;
    font-weight: 600;
    margin-right: 2px;
}

.premium-badge-message .premium-text {
    font-weight: 700;
    font-size: 1.4rem;
    margin-right: 145px;
    margin-top: 3px;
}

.block-icon {
    font-size: 18px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
}

.block-icon svg {
    display: block;
    flex-shrink: 0;
}

/* Field Group Styles */
.config-field-group {
    display: flex;
    align-items: flex-start;
    margin-bottom: 4px;
    padding: 3px 0;
}

.config-field-group:last-child {
    margin-bottom: 0;
    padding-bottom: 0;
}

.config-field-label {
    flex: 0 0 35%;
    padding-right: 15px;
}

.config-field-label label {
    display: block;
    font-size: 14px;
    color: #333;
    line-height: 1.5;
}

.main-label {
    font-weight: 500;
}

.required {
    color: #e02b27;
}

.config-field-input {
    flex: 1;
}

.filter-select,
.admin__control-text {
    width: 100%;
    max-width: 400px;
    /* padding: 8px 12px; */
    border: 1px solid #c2c2c2;
    border-radius: 3px;
    font-size: 14px;
    background-color: #fff;
}

.filter-select:focus,
.admin__control-text:focus {
    border-color: rgb(240, 156, 22);
    outline: none;
    box-shadow: 0 0 3px rgb(240, 156, 22);
}

/* Hidden field groups */
.hidden {
    display: none !important;
}

/* Save Button */
.tab-save-button {
    margin-top: 30px;
    padding-top: 20px;
}

/* Custom Save Configuration Button - No Magento Default Styles */
.save-config-btn {
    background-color: #eb5202;
    border: 1px solid #eb5202;
    color: #fff;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    line-height: 1.5;
    text-align: center;
    display: inline-block;
    text-decoration: none;
    box-shadow: none;
    outline: none;
    min-width: 150px;
}

.save-config-btn:hover {
    background-color: #d64a02;
    border-color: #d64a02;
    color: #fff;
}

.save-config-btn:active {
    background-color: #c14402;
    border-color: #c14402;
    color: #fff;
}

.save-config-btn:focus {
    outline: none;
    box-shadow: 0 0 0 2px rgba(235, 82, 2, 0.3);
}

.save-config-btn span {
    display: inline-block;
}

.action-default.primary {
    background-color: #eb5202;
    border: 1px solid #eb5202;
    color: #fff;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 3px;
    cursor: pointer;
    transition: background-color 0.2s;
}

.action-default.primary:hover {
    background-color: #d64a02;
}

/* Field Error Styles */
.field-error {
    font-size: 12px;
    margin-top: 5px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .config-field-group {
        flex-direction: column;
    }
    
    .config-field-label {
        flex: 1;
        padding-right: 0;
        margin-bottom: 10px;
    }
    
    .filter-select,
    .admin__control-text {
        max-width: 100%;
    }
}

/* Dropdown Styling for Configuration Tab */
.config-dropdown {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #c2c2c2;
    border-radius: 3px;
    background-color: #fff;
    font-size: 14px;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    color: #333;
    line-height: 1.5;
    transition: border-color 0.2s ease;
}

.config-dropdown:hover {
    border-color: #adadad;
}

.config-dropdown:focus {
    border-color: rgb(240, 156, 22);
    outline: none;
    box-shadow: 0 0 3px rgb(240, 156, 22);
}

.config-dropdown:disabled {
    background-color: #f5f5f5;
    color: #999;
    cursor: not-allowed;
    opacity: 0.6;
}

/* Style for multiselect dropdown */
.config-dropdown[multiple] {
    min-height: 150px;
    overflow-y: auto;
}

.config-dropdown[multiple] option {
    padding: 6px 8px;
    border-radius: 2px;
    margin: 2px 0;
}

.config-dropdown[multiple] option:hover {
    background-color: #f0f0f0;
}

.config-dropdown[multiple] option:checked {
    background-color: #1979c3;
    color: #fff;
    font-weight: 500;
}

/* Dropdown options styling */
.config-dropdown option {
    padding: 8px 12px;
    font-size: 14px;
    color: #333;
    background-color: #fff;
}

.config-dropdown option:hover {
    background-color: #f5f5f5;
}

.config-dropdown option:checked:not([multiple]) {
    background-color: #1979c3;
    color: #fff;
}

.config-field-input {
    position: relative;
}

.config-field-input.has-multiselect .config-dropdown {
    height: auto;
    min-height: 200px;
}

.config-field-group {
    margin-bottom: 20px;
}

.config-field-label {
    margin-bottom: 8px;
}

.config-field-label .main-label {
    font-weight: 500;
    /* color: #333; */
    font-size: 1.4rem;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
}

.admin__control-text {
    width: 100%;
    padding: 8px 12px;
    border: 1px solid #c2c2c2;
    border-radius: 3px;
    background-color: #fff;
    font-size: 14px;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    color: #333;
    line-height: 1.5;
    transition: border-color 0.2s ease;
}

.admin__control-text:hover {
    border-color: #adadad;
}

.admin__control-text:focus {
    border-color: rgb(240, 156, 22);
    outline: none;
    box-shadow: 0 0 3px rgb(240, 156, 22);
}

.admin__control-text:disabled {
    background-color: #f5f5f5;
    color: #999;
    cursor: not-allowed;
}

.status-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 600;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.5;
    transition: all 0.2s ease;
    cursor: default;
}

.status-badge.status-success {
    background-color: #e8f5e9;
    color: #2e7d32;
}

.status-badge.status-success:hover {
    background-color: #c8e6c9;
}

.status-badge.status-failure,
.status-badge.status-failed {
    background-color: #ffebee;
    color: #c62828;
}

.status-badge.status-failure:hover,
.status-badge.status-failed:hover {
    background-color: #ffcdd2;
}

.custom-multiselect-wrapper {
    position: relative;
    max-width: 500px;
    width: 100%;
}

.custom-multiselect-display {
    position: relative;
    border: 1px solid #d1d5db;
    border-radius: 4px;
    background-color: #fff;
    max-width: 400px;
    min-height: 38px;
    padding: 4px 35px 4px 8px;
    cursor: pointer;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 4px;
    transition: all 0.2s ease;
}

.custom-multiselect-display:hover {
    border-color: #9ca3af;
}

.custom-multiselect-display.active {
    border-color: #4A90E2;
    box-shadow: 0 0 0 1px #4A90E2;
}

.selected-tags-container {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
    min-width: 0;
    align-items: center;
}

.selected-tag {
    display: inline-flex;
    align-items: center;
    background-color: #f1f5f7;
    border: 1px solid #798691;
    color: #38353f;
    padding: 4px 24px 4px 8px;
    border-radius: 3px;
    font-size: 13px;
    line-height: 1.5;
    position: relative;
    white-space: nowrap;
}

.selected-tag .tag-close {
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px;
    height: 16px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    font-weight: bold;
}

.selected-tag .tag-close:hover {
    color: #0d47a1;
}

.multiselect-search-input {
    flex: 1;
    min-width: 120px;
    border: none;
    outline: none;
    padding: 6px 0;
    font-size: 14px;
    color: #333;
    background: transparent;
    height: 0px;
    margin-right: 25px;
}

.multiselect-search-input::placeholder {
    color: #9ca3af;
}

.multiselect-arrow {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    pointer-events: none;
    flex-shrink: 0;
    z-index: 1;
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    border-top: 5px solid #514943;
}

.custom-multiselect-dropdown {
    max-width: 400px;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background-color: #fff;
    border: 1px solid #4A90E2;
    border-radius: 4px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    z-index: 1000;
    max-height: 300px;
    overflow-y: auto;
    margin-top: 4px;
}

.multiselect-options {
    padding: 4px 0;
}

.multiselect-option {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    cursor: pointer;
    transition: background-color 0.2s ease;
}

.multiselect-option:hover {
    background-color: #f5f5f5;
}

.multiselect-option input[type="checkbox"] {
    margin-right: 8px;
    width: 16px;
    height: 16px;
    cursor: pointer;
}

.multiselect-option span {
    font-size: 14px;
    color: #333;
    flex: 1;
}

th.sortable {
    cursor: pointer;
    position: relative;
    user-select: none;
    padding-right: 25px !important;
}

th.sortable:hover {
    background-color: #f5f5f5;
}

th.sortable::after {
    content: '';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    width: 0;
    height: 0;
    border-left: 4px solid transparent;
    border-right: 4px solid transparent;
    opacity: 0.3;
}

th.sortable.asc::after {
    border-bottom: 5px solid #514943;
    border-top: none;
    opacity: 1;
}

th.sortable.desc::after {
    border-top: 5px solid #514943;
    border-bottom: none;
    opacity: 1;
}

/* Session Details Popup Styles */
.session-details-popup {
    position: fixed;
    top: 0;
    right: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 10000;
    display: flex;
    justify-content: flex-end;
    animation: fadeIn 0.2s ease;
}

.session-details-content {
    width: 100%;
    max-width: 800px;
    background-color: #fff;
    box-shadow: -2px 0 10px rgba(0, 0, 0, 0.2);
    display: flex;
    flex-direction: column;
    height: 100%;
    animation: slideInRight 0.3s ease;
    overflow: hidden;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideInRight {
    from { transform: translateX(100%); }
    to { transform: translateX(0); }
}

.session-details-header {
    background-color: #fff;
    color: #333;
    padding: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #ddd;
}

.session-details-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #333;
}

.session-details-close {
    background: none;
    border: none;
    color: #333;
    font-size: 24px;
    cursor: pointer;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
    transition: opacity 0.2s ease;
    font-weight: 300;
}

.session-details-close:hover {
    opacity: 0.6;
    color: #000;
}

.session-details-body {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background-color: #fff;
}

.session-details-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 0;
    background-color: #fff;
}

.session-details-table th,
.session-details-table td {
    padding: 12px;
    border: 1px solid #ddd;
    text-align: left;
    font-size: 13px;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

.session-details-table th {
    background-color: #f5f5f5;
    font-weight: 600;
    color: #333;
}

.session-details-table tbody tr:hover {
    background-color: #f9f9f9;
}

.session-details-table td {
    background-color: #fff;
    color: #333;
}

.session-details-table tbody tr {
    background-color: #fff;
}

.session-details-table tbody tr:nth-child(even) {
    background-color: #f9f9f9;
}

/* Custom View Button CSS - Override Magento Defaults */
.view-session-btn,
button.view-session-btn,
.action-default.view-session-btn {
    background: none !important;
    background-color: transparent !important;
    color: #007bdb !important;
    border: none !important;
    padding: 0 !important;
    border-radius: 0 !important;
    cursor: pointer;
    font-size: 14px !important;
    font-weight: 400 !important;
    text-decoration: none !important;
    display: inline !important;
    transition: none !important;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif !important;
    box-shadow: none !important;
    outline: none !important;
}

.view-session-btn:hover,
button.view-session-btn:hover,
.action-default.view-session-btn:hover,
.view-session-btn:focus,
button.view-session-btn:focus,
.action-default.view-session-btn:focus,
.view-session-btn:active,
button.view-session-btn:active,
.action-default.view-session-btn:active {
    background: none !important;
    background-color: transparent !important;
    color: #007bdb !important;
    border: none !important;
    text-decoration: none !important;
    box-shadow: none !important;
    outline: none !important;
}

.terminate-session-btn {
    padding: 6px 12px;
    background-color: #f5f5f5;
    color: #333;
    border: 1px solid #adadad;
    border-radius: 3px;
    cursor: pointer;
    font-size: 13px;
    transition: background-color 0.2s ease, border-color 0.2s ease;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-weight: 400;
}

.terminate-session-btn:hover {
    background-color: #e8e8e8;
    border-color: #999;
}

.terminate-session-btn::after {
    content: '×';
    font-size: 16px;
    margin-left: 5px;
    font-weight: 300;
    line-height: 1;
}

.terminate-session-btn span {
    display: inline-block;
}

/* Terminate Button Tooltip */
.terminate-session-btn-wrapper {
    position: relative;
    display: inline-block;
}

.terminate-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    margin-bottom: 8px;
    background-color: #514943;
    color: #fff;
    padding: 12px 16px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    white-space: normal;
    width: 280px;
    text-align: left;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
    z-index: 1000;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

.terminate-session-btn-wrapper.show-tooltip .terminate-tooltip {
    pointer-events: auto;
}

.terminate-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    width: 0;
    height: 0;
    border-left: 8px solid transparent;
    border-right: 8px solid transparent;
    border-top: 8px solid #5a3825;
}

.terminate-session-btn-wrapper.show-tooltip .terminate-tooltip {
    opacity: 1;
    visibility: visible;
}

.terminate-tooltip-link {
    color: #eb5e00;
    font-weight: 600;
    text-decoration: none;
    cursor: pointer;
    transition: opacity 0.2s ease;
}

.terminate-tooltip-link:hover {
    opacity: 0.8;
    text-decoration: none;
    color: #eb5e00;
}

/* Mass Action Confirmation Dialog - Custom Styles */
#mass_action_confirm_dialog {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
}

.mass-action-dialog-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1;
}

.mass-action-dialog-content {
    position: relative;
    z-index: 2;
    background-color: #fff;
    border-radius: 4px;
    box-shadow: 0 4px 12px rgba(242, 169, 24, 0.15);
    min-width: 320px;
    max-width: 380px;
    width: auto;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
}

.mass-action-dialog-header {
    padding: 16px 12px;
    /* border-bottom: 1px solid #e3e3e3; */
    background-color: #fff;
    border-radius: 4px 4px 0 0;
}

.mass-action-dialog-header h3 {
    margin: 0;
    font-size: 18px;
    font-weight: 600;
    color: #eb5202;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

.mass-action-dialog-body {
    padding: 24px;
    flex: 1;
    overflow-y: auto;
    background-color: #fff;
}

.mass-action-dialog-body p {
    margin: 0;
    font-size: 14px;
    color: #514943;
    line-height: 1.5;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
}

.mass-action-dialog-footer {
    padding: 16px 24px;
    /* border-top: 1px solid #e3e3e3; */
    background-color: #fff;
    border-radius: 0 0 4px 4px;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
}

.mass-action-confirm-btn,
.mass-action-cancel-btn {
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    min-width: 100px;
}

.mass-action-confirm-btn {
    background-color: #eb5202;
    border: 1px solid #eb5202;
    color: #fff;
}

.mass-action-confirm-btn:hover {
    background-color: #d64a02;
    border: 1px solid #d64a02;
    color: #fff;
}

.mass-action-confirm-btn:active {
    background-color: #c14402;
    border: 1px solid #c14402;
    color: #fff;
}

.mass-action-cancel-btn {
    background-color: #fff;
    border: 1px solid #eb5202;
    border-radius: 4px;
    color: #000;
}

.mass-action-cancel-btn:hover {
    background-color: #f5f5f5;
    border: 1px solid #eb5202;
    color: #000;
}

.mass-action-cancel-btn:active {
    background-color: #e8e8e8;
    border: 1px solid #eb5202;
    color: #000;
}

/* Override Magento default styles for action-primary and action-secondary buttons */
.mass-action-dialog-footer .action-primary,
.mass-action-dialog-footer .action-secondary {
    outline: none;
    box-shadow: none;
}

.mass-action-dialog-footer .action-primary {
    background-color: #eb5202;
    border: 1px solid #eb5202;
    color: #fff;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    border-radius: 3px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    min-width: 100px;
}

.mass-action-dialog-footer .action-primary:hover {
    background-color: #d64a02;
    border-color: #d64a02;
    color: #fff;
    outline: none;
    box-shadow: none;
}

.mass-action-dialog-footer .action-primary:active {
    background-color: #c14402;
    border-color: #c14402;
    color: #fff;
    outline: none;
    box-shadow: none;
}

.mass-action-dialog-footer .action-primary:focus {
    background-color: #eb5202;
    border-color: #eb5202;
    color: #fff;
    outline: none;
    box-shadow: none;
}

.mass-action-dialog-footer .action-secondary {
    background-color: #fff;
    border: 1px solid #eb5202;
    border-radius: 4px;
    color: #000 !important;
    padding: 10px 20px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    font-family: 'Open Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif;
    min-width: 100px;
}

.mass-action-dialog-footer .action-secondary:hover {
    background-color: #f5f5f5;
    border-color: #eb5202;
    color: #000 !important;
    outline: none;
    box-shadow: none;
}

.mass-action-dialog-footer .action-secondary:hover span {
    color: #000 !important;
}

.mass-action-dialog-footer .action-secondary:active {
    background-color: #e8e8e8;
    border-color: #eb5202;
    color: #000 !important;
    outline: none;
    box-shadow: none;
}

.mass-action-dialog-footer .action-secondary:active span {
    color: #000 !important;
}

.mass-action-dialog-footer .action-secondary:focus {
    background-color: #fff;
    border-color: #eb5202;
    color: #000 !important;
    outline: none;
    box-shadow: none;
}

.mass-action-dialog-footer .action-secondary:focus span {
    color: #000 !important;
}

.mass-action-dialog-footer .action-secondary span {
    color: #000 !important;
}

/* Responsive adjustments for dialog */
@media (max-width: 768px) {
    .mass-action-dialog-content {
        min-width: 90%;
        max-width: 90%;
    }
    
    .mass-action-dialog-footer {
        flex-direction: column;
        gap: 10px;
    }
    
    .mass-action-confirm-btn,
    .mass-action-cancel-btn {
        width: 100%;
    }
}

/* Support Form Success Message Styles */
#support-form-container {
    min-height: 320px; /* Reduced from 400px */
}

#support-form-container.showing-success {
    min-height: 230px; /* Smaller height when showing success message */
}

.support-form-content {
    min-height: 250px; /* Reduced from 350px */
    display: flex;
    flex-direction: column;
}

#support-success-message {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px 20px;
    text-align: center;
    min-height: 240px; /* Smaller height for success message */
}

#support-success-message.show {
    display: flex !important;
}

.support-success-icon {
    width: 32px;
    height: 32px;
    background-color: #4caf50;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 16px; /* Reduced from 24px */
    flex-shrink: 0;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
}

.support-success-icon svg {
    width: 20px;
    height: 20px;
    display: block;
}

.support-success-text{
display: block;
text-align: center;
padding: 10px 15px; /* Reduced top/bottom padding */
font-size: 1.3rem;
line-height: 1.2;
border-radius: 5px;
margin-top: 0; /* Removed negative margin */
padding-left: 1rem !important;
padding-right: 1rem !important;
}

.support-success-text p {
    margin: 6px 0; /* Reduced from 8px */
    color: #514943;
}

.support-success-text strong {
    color:black;
    font-weight: 600;
}

#support-popup-form {
    min-height: 290px; /* Reduced from 350px to match success message height */
    display: flex;
    flex-direction: column;
    padding-bottom: 10px; /* Reduce bottom padding */
}

</style>

<script>
    require(['MiniOrange_AdminLogs/js/adminSettings', 'domReady!'], function(adminSettings) {
        adminSettings.initConfiguration();
        
        function getActiveTab() {
            // Check which route we're on (for direct navigation)
            var currentPath = window.location.pathname;
            if (currentPath.indexOf('adminlogs/upgrade') !== -1) {
                return 'upgrade';
            }
            if (currentPath.indexOf('adminlogs/logsview') !== -1) {
                return 'logs_view';
            }
            if (currentPath.indexOf('adminlogs/configuration') !== -1) {
                return 'configuration';
            }
            
            // Fallback: Check URL parameter
            var urlParams = new URLSearchParams(window.location.search);
            var tabFromUrl = urlParams.get('active_tab');
            if (tabFromUrl) {
                return tabFromUrl;
            }
            
            // Default to configuration
            return 'configuration';
        }
        
        // Don't interfere with PHP-set active tabs - CSS handles visibility via .active class
        // Only update if we need to handle browser navigation (back/forward)
        function setActiveTab(tabName, updateHistory) {
            // updateHistory defaults to true (use pushState), false means replaceState
            if (typeof updateHistory === 'undefined') {
                updateHistory = true;
            }
            
            // Remove active class from all tabs
            document.querySelectorAll('.config-tab-button').forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.config-tab-content').forEach(function(content) {
                content.classList.remove('active');
                // Ensure hidden tabs are not visible
                content.style.display = 'none';
            });
            
            var tabButton = document.querySelector('[data-tab="' + tabName + '"]');
            var tabContent = document.getElementById('tab-' + tabName);
            
            if (tabButton && tabContent) {
                tabButton.classList.add('active');
                tabContent.classList.add('active');
                // Ensure active tab is visible
                tabContent.style.display = 'block';
                sessionStorage.setItem('activeConfigTab', tabName);
            }
        }
        
        // Don't run setActiveTab on initial load - PHP already set the correct tab via .active class
        // Only handle browser back/forward navigation
        
        // Ensure PHP-set active states are preserved on initial load
        // Find which tab PHP marked as active and ensure it's the only one visible
        (function() {
            var activeTabContent = document.querySelector('.config-tab-content.active');
            var activeTabButton = document.querySelector('.config-tab-button.active');
            
            // Hide all tabs first
            document.querySelectorAll('.config-tab-content').forEach(function(content) {
                content.style.display = 'none';
                if (content !== activeTabContent) {
                    content.classList.remove('active');
                }
            });
            
            // Show the active tab
            if (activeTabContent) {
                activeTabContent.style.display = 'block';
            }
            
            // Ensure only the active button has the active class
            if (activeTabButton) {
                document.querySelectorAll('.config-tab-button').forEach(function(button) {
                    if (button !== activeTabButton) {
                        button.classList.remove('active');
                    }
                });
            }
        })();
        
        // Handle tab button clicks - switch tabs without page reload
        document.querySelectorAll('.config-tab-button').forEach(function(button) {
            button.addEventListener('click', function(e) {
                e.preventDefault(); // Prevent default link navigation
                
                var tabName = this.getAttribute('data-tab');
                if (tabName) {
                    // Switch to the selected tab
                    setActiveTab(tabName, true);
                    
                    // Update URL without reloading
                    var url = new URL(this.href);
                    window.history.pushState({tab: tabName}, '', url.pathname + url.search);
                }
            });
        });
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            var urlParams = new URLSearchParams(window.location.search);
            var tabFromUrl = urlParams.get('active_tab');
            if (tabFromUrl) {
                setActiveTab(tabFromUrl, false);
            } else {
                // If no URL param, get tab from other sources
                var tab = getActiveTab();
                setActiveTab(tab, false);
            }
        });
        
        var logsTypeSelect = document.getElementById('logs_type');
        if (logsTypeSelect) {
            var urlParams = new URLSearchParams(window.location.search);
            var logsTypeFromUrl = urlParams.get('logs_type') || 'login_logout';
            
            if (logsTypeFromUrl) {
                logsTypeSelect.value = logsTypeFromUrl;
            }
            
            function showTableForLogType(logType) {
                document.querySelectorAll('.logs-table-content').forEach(function(table) {
                    table.style.display = 'none';
                    table.classList.remove('active');
                });
                
                var selectedTable = document.getElementById('table-' + logType);
                
                if (selectedTable) {
                    selectedTable.style.display = 'block';
                    selectedTable.classList.add('active');
                    
                    var event = new CustomEvent('logsTypeChanged', { detail: { type: logType } });
                    document.dispatchEvent(event);
                } else {
                    console.error('Table not found for type:', logType);
                }
            }
            
            showTableForLogType(logsTypeFromUrl);
            
            logsTypeSelect.addEventListener('change', function() {
                var selectedType = this.value;
                showTableForLogType(selectedType);
                
                var newUrl = new URL(window.location);
                newUrl.searchParams.set('logs_type', selectedType);
                // Preserve active_tab parameter if it exists
                var currentActiveTab = new URLSearchParams(window.location.search).get('active_tab');
                if (currentActiveTab) {
                    newUrl.searchParams.set('active_tab', currentActiveTab);
                }
                window.history.pushState({}, '', newUrl);
            });
        }
        
        function showError(inputId, errorId, message) {
            var input = document.getElementById(inputId);
            var errorDiv = document.getElementById(errorId);
            if (input && errorDiv) {
                input.style.border = '1px solid #e02b27';
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function clearError(inputId, errorId) {
            var input = document.getElementById(inputId);
            var errorDiv = document.getElementById(errorId);
            if (input && errorDiv) {
                input.style.border = '';
                errorDiv.style.display = 'none';
            }
        }
        
        function validateNumericField(inputId, errorId, fieldName) {
            var input = document.getElementById(inputId);
            if (!input) return true;
            
            var value = input.value.trim();
            
            if (value === '') {
                showError(inputId, errorId, 'This is a required field.');
                return false;
            }
            
            if (isNaN(value) || !(/^\d+$/.test(value))) {
                showError(inputId, errorId, 'Please enter a valid number.');
                return false;
            }
            
            var numValue = parseInt(value, 10);
            if (numValue <= 0) {
                showError(inputId, errorId, 'Please enter a number greater than 0.');
                return false;
            }
            
            clearError(inputId, errorId);
            return true;
        }
        
        function togglePeriodField(selectId, groupId) {
            var select = document.getElementById(selectId);
            var group = document.getElementById(groupId);
            
            if (select && group) {
                if (select.value === '1') {
                    group.classList.remove('hidden');
                } else {
                    group.classList.add('hidden');
                }
            }
        }
        
        togglePeriodField('login_attempts_auto_cleaning', 'login_attempts_period_group');
        
        var loginAttemptsSelect = document.getElementById('login_attempts_auto_cleaning');
        if (loginAttemptsSelect) {
            loginAttemptsSelect.addEventListener('change', function() {
                togglePeriodField('login_attempts_auto_cleaning', 'login_attempts_period_group');
            });
        }
        
        var activeSessionsSelect = document.getElementById('active_sessions_auto_cleaning');
        if (activeSessionsSelect) {
            activeSessionsSelect.addEventListener('change', function() {
                togglePeriodField('active_sessions_auto_cleaning', 'active_sessions_period_group');
            });
        }

        var concurrentSessionsSelect = document.getElementById('concurrent_sessions_auto_cleaning');
        if (concurrentSessionsSelect) {
            concurrentSessionsSelect.addEventListener('change', function() {
                togglePeriodField('concurrent_sessions_auto_cleaning', 'concurrent_sessions_period_group');
            });
        }

        var logCleaningForm = document.getElementById('log-cleaning-form');
        if (logCleaningForm) {
            logCleaningForm.addEventListener('submit', function(e) {
                var isValid = true;
                var loginAttemptsEnabled = document.getElementById('login_attempts_auto_cleaning');
                if (loginAttemptsEnabled && loginAttemptsEnabled.value === '1') {
                    if (!validateNumericField('login_attempts_period', 'login_attempts_period_error', 'Auto-Cleaning Period')) {
                        isValid = false;
                    }
                }
                
                if (!isValid) {
                    e.preventDefault();
                    return false;
                }
                
                var activeTabContent = this.querySelector('.config-tab-content.active');
                if (activeTabContent) {
                    var tabId = activeTabContent.id.replace('tab-', '');
                    var hiddenField = this.querySelector('input[name="active_tab"]');
                    if (hiddenField) {
                        hiddenField.value = tabId;
                    }
                }
            });
        }
        
        ['login_attempts_period'].forEach(function(inputId) {
            var input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('blur', function() {
                    var errorId = inputId + '_error';
                    var selectId = inputId.replace('_period', '_auto_cleaning');
                    var select = document.getElementById(selectId);
                    
                    if (select && select.value === '1') {
                        validateNumericField(inputId, errorId, 'Auto-Cleaning Period');
                    }
                });
                
                input.addEventListener('input', function() {
                    var errorId = inputId + '_error';
                    clearError(inputId, errorId);
                });
            }
        });
        
        document.querySelectorAll('form[id$="-form"], #config-form').forEach(function(form) {
            if (form.id !== 'log-cleaning-form') {
                form.addEventListener('submit', function(e) {
                    if (form.id === 'config-form') {
                        var selectedCheckboxes = document.querySelectorAll('#objects_to_log_options input[type="checkbox"]:checked');
                        if (selectedCheckboxes.length === 0) {
                            var allCheckbox = document.querySelector('#objects_to_log_options input[type="checkbox"][value="all"]');
                            if (allCheckbox) {
                                allCheckbox.checked = true;
                                var changeEvent = new Event('change', { bubbles: true });
                                allCheckbox.dispatchEvent(changeEvent);
                            }
                        }
                    }
                    
                    var activeTabContent = this.querySelector('.config-tab-content.active');
                    if (activeTabContent) {
                        var tabId = activeTabContent.id.replace('tab-', '');
                        var hiddenField = this.querySelector('input[name="active_tab"]');
                        if (hiddenField) {
                            hiddenField.value = tabId;
                        }
                    }
                });
            }
        });
        
        var selectAllLoginLogout = document.getElementById('select-all-login-logout');
        if (selectAllLoginLogout) {
            selectAllLoginLogout.addEventListener('change', function() {
                var checkboxes = document.querySelectorAll('#login-logout-tbody .row-checkbox');
                checkboxes.forEach(function(checkbox) {
                    checkbox.checked = selectAllLoginLogout.checked;
                });
            });
        }

        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('row-checkbox') && e.target.closest('#login-logout-tbody')) {
                var allCheckboxes = document.querySelectorAll('#login-logout-tbody .row-checkbox');
                var checkedCheckboxes = document.querySelectorAll('#login-logout-tbody .row-checkbox:checked');
                var selectAll = document.getElementById('select-all-login-logout');
                
                if (selectAll) {
                    selectAll.checked = allCheckboxes.length === checkedCheckboxes.length;
                }
            }
        });

        var logsActionsSelect = document.getElementById('logs_actions');
        var logsTypeSelect = document.getElementById('logs_type');
        var massActionForm = document.getElementById('mass_action_form');
        var confirmDialog = document.getElementById('mass_action_confirm_dialog');
        var confirmBtn = document.getElementById('mass_action_confirm_btn');
        var cancelBtn = document.getElementById('mass_action_cancel_btn');

        function getCheckboxSelector(logType) {
            switch(logType) {
                case 'login_logout':
                    return '#login-logout-tbody .row-checkbox:checked';
                // Commented out: Active sessions and Concurrent sessions no longer have checkboxes
                // case 'active_sessions':
                //     return '#active-sessions-tbody .row-checkbox:checked';
                // case 'concurrent_sessions':
                //     return '#concurrent-sessions-tbody .row-checkbox:checked';
                default:
                    return '';
            }
        }

        function performMassAction(logType, actionType) {
            var checkboxSelector = getCheckboxSelector(logType);
            if (!checkboxSelector) {
                alert('<?= $block->escapeJs(__('Invalid log type selected.')) ?>');
                return;
            }

            var selectedCheckboxes = document.querySelectorAll(checkboxSelector);
            var ids = [];
            
            selectedCheckboxes.forEach(function(cb) {
                if (cb.value) {
                    ids.push(cb.value);
                }
            });

            if (ids.length === 0) {
                alert('<?= $block->escapeJs(__('No valid records selected.')) ?>');
                return;
            }

            document.getElementById('selected_ids').value = ids.join(',');
            document.getElementById('log_type').value = logType;
            document.getElementById('action_type').value = actionType;
            if (massActionForm) {
                massActionForm.submit();
            }
        }

        function closeDialog() {
            if (confirmDialog) {
                confirmDialog.style.display = 'none';
            }
            if (logsActionsSelect) {
                logsActionsSelect.value = 'default';
            }
        }

        if (logsActionsSelect) {
            logsActionsSelect.addEventListener('change', function() {
                var actionValue = this.value;
                if (actionValue === 'default') {
                    return;
                }
                var currentLogType = logsTypeSelect ? logsTypeSelect.value : 'login_logout';
                var checkboxSelector = getCheckboxSelector(currentLogType);

                if (!checkboxSelector) {
                    alert('<?= $block->escapeJs(__('Invalid log type selected.')) ?>');
                    this.value = 'default';
                    return;
                }

                var selectedCheckboxes = document.querySelectorAll(checkboxSelector);
                
                if (selectedCheckboxes.length === 0) {
                    alert('<?= $block->escapeJs(__('Please select at least one record to perform this action.')) ?>');
                    this.value = 'default'; // Reset dropdown
                    return;
                }

                if (confirmDialog) {
                    confirmDialog.style.display = 'block';
                }

                if (confirmBtn) {
                    var newConfirmBtn = confirmBtn.cloneNode(true);
                    confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                    confirmBtn = newConfirmBtn;
                    
                    confirmBtn.onclick = function() {
                        performMassAction(currentLogType, actionValue);
                        closeDialog();
                    };
                }

                if (cancelBtn) {
                    var newCancelBtn = cancelBtn.cloneNode(true);
                    cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
                    cancelBtn = newCancelBtn;
                    
                    cancelBtn.onclick = function() {
                        closeDialog();
                    };
                }

                var overlay = document.querySelector('.mass-action-dialog-overlay');
                if (overlay) {
                    overlay.onclick = function() {
                        closeDialog();
                    };
                }
            });
        }
        
        var exportDropdownToggle = document.getElementById('export-dropdown-toggle');
        var exportDropdownMenu = document.getElementById('export-dropdown-menu');
        var exportRadios = document.querySelectorAll('.export-radio');
        
        if (exportDropdownToggle && exportDropdownMenu) {
            exportDropdownToggle.addEventListener('click', function(e) {
                e.stopPropagation();
                var isVisible = exportDropdownMenu.style.display !== 'none';
                exportDropdownMenu.style.display = isVisible ? 'none' : 'block';
            });
            
            document.addEventListener('click', function(e) {
                if (exportDropdownMenu && exportDropdownToggle) {
                    if (!exportDropdownMenu.contains(e.target) && !exportDropdownToggle.contains(e.target)) {
                        exportDropdownMenu.style.display = 'none';
                    }
                }
            });
            
            exportRadios.forEach(function(radio) {
                radio.addEventListener('change', function() {
                    var selectedFormat = this.value;
                    var formatLabel = selectedFormat.toUpperCase();
                    
                    var logsTypeSelect = document.getElementById('logs_type');
                    var currentLogType = logsTypeSelect ? logsTypeSelect.value : 'login_logout';
                    
                    var hasLogs = false;
                    
                    switch(currentLogType) {
                        case 'login_logout':
                            if (typeof window.loginLogoutLogs !== 'undefined' && window.loginLogoutLogs.length > 0) {
                                hasLogs = true;
                            } else {
                                var tbody = document.querySelector('#login-logout-tbody');
                                if (tbody) {
                                    var rows = tbody.querySelectorAll('tr');
                                    for (var i = 0; i < rows.length; i++) {
                                        var row = rows[i];
                                        var checkbox = row.querySelector('.row-checkbox');
                                        if (checkbox && checkbox.value) {
                                            hasLogs = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            break;
                        case 'active_sessions':
                            if (typeof window.activeSessionsLogs !== 'undefined' && window.activeSessionsLogs.length > 0) {
                                hasLogs = true;
                            } else {
                                var tbody = document.querySelector('#active-sessions-tbody');
                                if (tbody) {
                                    var rows = tbody.querySelectorAll('tr');
                                    for (var i = 0; i < rows.length; i++) {
                                        var row = rows[i];
                                        var checkbox = row.querySelector('.row-checkbox');
                                        if (checkbox && checkbox.value) {
                                            hasLogs = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            break;
                        case 'concurrent_sessions':
                            if (typeof window.concurrentSessionsLogs !== 'undefined' && window.concurrentSessionsLogs.length > 0) {
                                hasLogs = true;
                            } else {
                                var tbody = document.querySelector('#concurrent-sessions-tbody');
                                if (tbody) {
                                    var rows = tbody.querySelectorAll('tr');
                                    for (var i = 0; i < rows.length; i++) {
                                        var row = rows[i];
                                        // Skip detail rows
                                        if (row.classList.contains('session-details-row')) continue;
                                        var checkbox = row.querySelector('.row-checkbox');
                                        if (checkbox && checkbox.value) {
                                            hasLogs = true;
                                            break;
                                        }
                                    }
                                }
                            }
                            break;
                    }
                    
                    if (!hasLogs) {
                        alert('<?= $block->escapeJs(__('No logs available to export.')) ?>');
                        radio.checked = false;
                        var exportLabel = exportDropdownToggle.querySelector('.export-label');
                        if (exportLabel) {
                            exportLabel.textContent = '<?= $block->escapeJs(__('Export')) ?>';
                        }
                        return;
                    }
                    
                    var exportLabel = exportDropdownToggle.querySelector('.export-label');
                    if (exportLabel) {
                        exportLabel.textContent = 'Export (' + formatLabel + ')';
                    }
                    
                    exportDropdownMenu.style.display = 'none';
                    
                    var exportForm = document.getElementById('export_form');
                    var exportFormatInput = document.getElementById('export_format');
                    var exportLogTypeInput = document.getElementById('export_log_type');
                    
                    if (exportForm && exportFormatInput) {
                        exportFormatInput.value = selectedFormat;
                        if (exportLogTypeInput) {
                            exportLogTypeInput.value = currentLogType;
                        }
                        
                        var exportUrl = '';
                        if (selectedFormat === 'csv') {
                            exportUrl = "<?= $block->escapeUrl($block->getUrl('adminlogs/export/csv')) ?>";
                        } else if (selectedFormat === 'excel') {
                            exportUrl = "<?= $block->escapeUrl($block->getUrl('adminlogs/export/excel')) ?>";
                        }
                        
                        var iframe = document.createElement('iframe');
                        iframe.style.display = 'none';
                        iframe.name = 'export_iframe';
                        document.body.appendChild(iframe);
                        exportForm.target = 'export_iframe';
                        exportForm.action = exportUrl;
                        
                        exportForm.submit();
                        
                        setTimeout(function() {
                            if (iframe.parentNode) {
                                iframe.parentNode.removeChild(iframe);
                            }
                        }, 5000);
                        
                        setTimeout(function() {
                            if (exportLabel) {
                                exportLabel.textContent = '<?= $block->escapeJs(__('Export')) ?>';
                            }
                            exportRadios.forEach(function(radio) {
                                radio.checked = false;
                            });
                        }, 1000);
                    }
                });
            });
        }
    
    });
</script>

<script>
    require(['domReady!'], function() {
        var supportButton = document.getElementById('support-chat-button');
        var supportForm = document.getElementById('support-form-container');
        var closeSupportBtn = document.getElementById('close-support-form');
        var speechBubble = document.getElementById('support-speech-bubble');
        
        if (speechBubble) {
            speechBubble.style.opacity = '';
            speechBubble.style.visibility = '';
        }
        
        if (supportButton) {
            supportButton.addEventListener('click', function(e) {
                e.stopPropagation();
                if (supportForm.classList.contains('support-form-hidden')) {
                    supportForm.classList.remove('support-form-hidden');
                    supportForm.classList.add('support-form-visible');
                    if (speechBubble) {
                        speechBubble.classList.remove('show');
                    }
                    // Reset form and show form when opening popup
                    var popupForm = document.getElementById('support-popup-form');
                    var successMessage = document.getElementById('support-success-message');
                    var submitBtn = popupForm ? popupForm.querySelector('.support-submit-btn') : null;
                    if (popupForm) {
                        popupForm.style.display = 'block';
                        popupForm.reset();
                    }
                    if (successMessage) {
                        successMessage.style.display = 'none';
                        successMessage.classList.remove('show');
                    }
                    // Reset submit button state
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Submit';
                    }
                }
            });
            
            supportButton.addEventListener('mouseenter', function() {
                if (speechBubble && !supportForm.classList.contains('support-form-visible')) {
                    speechBubble.classList.add('show');
                    speechBubble.style.opacity = '';
                    speechBubble.style.visibility = '';
                }
            });
            
            supportButton.addEventListener('mouseleave', function() {
                if (speechBubble && !supportForm.classList.contains('support-form-visible')) {
                    speechBubble.classList.remove('show');
                }
            });
        }
        
        if (closeSupportBtn) {
            closeSupportBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                supportForm.classList.remove('support-form-visible');
                supportForm.classList.add('support-form-hidden');
                // Reset form and hide success message when closing
                var popupForm = document.getElementById('support-popup-form');
                var successMessage = document.getElementById('support-success-message');
                var submitBtn = popupForm ? popupForm.querySelector('.support-submit-btn') : null;
                if (popupForm) {
                    popupForm.style.display = 'block';
                    popupForm.reset();
                }
                if (successMessage) {
                    successMessage.style.display = 'none';
                }
                // Reset submit button state
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                }
            });
        }
        
        // Handle AJAX form submission - GET request with query parameters
        var popupForm = document.getElementById('support-popup-form');
        if (popupForm) {
            popupForm.addEventListener('submit', function(e) {
                // Prevent default form submission
                e.preventDefault();
                
                // Extract form data and trim whitespace
                var emailInput = document.getElementById('popup_support_email');
                var phoneInput = document.getElementById('popup_support_phone');
                var queryInput = document.getElementById('popup_support_query');
                
                var email = emailInput ? emailInput.value.trim() : '';
                var phone = phoneInput ? phoneInput.value.trim() : '';
                var query = queryInput ? queryInput.value.trim() : '';
                
                // Validate required fields before submission
                if (!email) {
                    alert('Please enter your email address.');
                    if (emailInput) emailInput.focus();
                    return;
                }
                
                if (!query) {
                    alert('Please enter your query.');
                    if (queryInput) queryInput.focus();
                    return;
                }
                
                // Basic email validation
                var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    alert('Please enter a valid email address.');
                    if (emailInput) emailInput.focus();
                    return;
                }
                
                var submitBtn = popupForm.querySelector('.support-submit-btn');
                var originalBtnText = submitBtn ? submitBtn.textContent : 'Submit';
                
                // Disable submit button and show loading state
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Submitting...';
                }
                
                // Build GET URL with query parameters
                var baseUrl = popupForm.action || '<?= $block->escapeUrl($supportUrl) ?>';
                // Handle both relative and absolute URLs
                try {
                    var url = new URL(baseUrl);
                } catch (e) {
                    // If baseUrl is relative, make it absolute
                    url = new URL(baseUrl, window.location.origin);
                }
                // Use parameter names that match controller expectations: email, phone, query
                url.searchParams.append('email', email);
                url.searchParams.append('phone', phone);
                url.searchParams.append('query', query);
                
                // Make asynchronous HTTP GET request
                fetch(url.toString(), {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(function(response) {
                    // Check if response is OK and is JSON
                    if (!response.ok) {
                        throw new Error('Server error: ' + response.status);
                    }
                    var contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        // If not JSON, try to parse as text first
                        return response.text().then(function(text) {
                            throw new Error('Server returned non-JSON response. Please check server logs.');
                        });
                    }
                })
                .then(function(data) {
                    // Handle response - show success/error message
                    if (data && data.success) {
                        // Hide form and show success message
                        popupForm.style.display = 'none';
                        var successMessage = document.getElementById('support-success-message');
                        var supportFormContainer = document.getElementById('support-form-container');
                        if (successMessage) {
                            successMessage.style.display = 'flex';
                            successMessage.classList.add('show'); // Add show class for proper display
                        }
                        // Reduce container height when showing success message
                        if (supportFormContainer) {
                            supportFormContainer.classList.add('showing-success');
                        }
                        
                        // Reset submit button state
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalBtnText;
                        }
                        
                        // Auto-close popup after 5 seconds
                        setTimeout(function() {
                            var supportForm = document.getElementById('support-form-container');
                            if (supportForm) {
                                supportForm.classList.remove('support-form-visible');
                                supportForm.classList.add('support-form-hidden');
                                supportForm.classList.remove('showing-success'); // Remove success class
                                // Reset form
                                popupForm.reset();
                                popupForm.style.display = 'block';
                                if (successMessage) {
                                    successMessage.style.display = 'none';
                                    successMessage.classList.remove('show');
                                }
                                // Reset submit button state
                                if (submitBtn) {
                                    submitBtn.disabled = false;
                                    submitBtn.textContent = originalBtnText;
                                }
                            }
                        }, 5000);
                    } else {
                        // Show error message
                        alert(data && data.message ? data.message : 'An error occurred. Please try again.');
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalBtnText;
                        }
                    }
                })
                .catch(function(error) {
                    // Handle error
                    console.error('Support form submission error:', error);
                    var errorMessage = 'An error occurred while submitting your request. ';
                    if (error.message) {
                        errorMessage += error.message;
                    } else {
                        errorMessage += 'Please try again or contact support.';
                    }
                    alert(errorMessage);
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalBtnText;
                    }
                });
            });
        }
    });
</script>

<script type="text/javascript">
    (function() {
        'use strict';
        
        function domReady(fn) {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', fn);
            } else {
                fn();
            }
        }
        
        function waitForJQuery(callback, maxAttempts) {
            maxAttempts = maxAttempts || 50;
            var attempts = 0;
            function check() {
                attempts++;
                if (typeof window.jQuery !== 'undefined') {
                    callback(window.jQuery);
                } else if (attempts < maxAttempts) {
                    setTimeout(check, 100);
                }
            }
            check();
        }
        
        domReady(function() {
            waitForJQuery(function($) {
                initPagination($);
            });
        });
        
        window.loginLogoutLogs = [];
        window.loginLogoutCurrentPage = 1;
        window.loginLogoutEntriesPerPage = 10;
        window.loginLogoutDataInitialized = false;
        
        function initPagination($) {
            var entriesDropdown = $('#entries_per_page');
            if (entriesDropdown.length === 0) {
                return;
            }
            
            var entriesPerPage = parseInt(entriesDropdown.val()) || 10;
            window.loginLogoutEntriesPerPage = entriesPerPage;
            
            function initLoginLogoutData() {
                if (window.loginLogoutDataInitialized && window.loginLogoutLogs.length > 0) {
                    return;
                }
                
                window.loginLogoutLogs = [];
                var tbody = $('#login-logout-tbody');
                var rows = tbody.find('tr');
                
                rows.each(function() {
                    var $row = $(this);
                    var $cells = $row.find('td');
                    
                    if ($cells.length > 1 && !$row.find('td[colspan]').length) {
                        var checkbox = $row.find('.row-checkbox');
                        window.loginLogoutLogs.push({
                            id: checkbox.length ? checkbox.val() : '',
                            loggedAt: $cells.eq(1).text().trim(),
                            username: $cells.eq(2).text().trim(),
                            fullName: $cells.eq(3).text().trim(),
                            type: $cells.eq(4).text().trim(),
                            status: $cells.eq(5).html(),
                            location: $cells.eq(6).text().trim(),
                            ipAddress: $cells.eq(7).text().trim()
                        });
                    }
                });
                window.originalLoginLogoutLogs = window.loginLogoutLogs.slice();
                window.loginLogoutDataInitialized = true;
            }
            
            function formatStatusBadge(statusHtml) {
                if (statusHtml && statusHtml.indexOf('status-badge') !== -1) {
                    return statusHtml;
                }
                var statusText = $(statusHtml).text() || statusHtml || '';
                var statusLower = statusText.toLowerCase().trim();
                var statusClass = 'status-failed';
                if (statusLower === 'success') {
                    statusClass = 'status-success';
                } else if (statusLower === 'failed' || statusLower === 'failure') {
                    statusClass = 'status-failed';
                }
                return '<span class="status-badge ' + statusClass + '">' + statusText + '</span>';
            }
            
            window.renderLoginLogoutTable = function() {
                var startIndex = (window.loginLogoutCurrentPage - 1) * window.loginLogoutEntriesPerPage;
                var endIndex = startIndex + window.loginLogoutEntriesPerPage;
                var paginatedLogs = window.loginLogoutLogs.slice(startIndex, endIndex);
                
                var tbody = $('#login-logout-tbody');
                tbody.empty();
                
                if (paginatedLogs.length === 0) {
                    tbody.append('<tr style="background-color: #fff;"><td colspan="8" style="padding: 12px; border: 1px solid #ddd; text-align: center;">No login/logout logs found.</td></tr>');
                } else {
                    paginatedLogs.forEach(function(log) {
                        var statusBadge = formatStatusBadge(log.status || '');
                        var row = '<tr style="background-color: #fff;">' +
                            '<td style="padding: 12px; border: 1px solid #ddd;"><input type="checkbox" class="row-checkbox" value="' + (log.id || '') + '" /></td>' +
                            '<td style="padding: 12px; border: 1px solid #ddd;">' + (log.loggedAt || '') + '</td>' +
                            '<td style="padding: 12px; border: 1px solid #ddd;">' + (log.username || '') + '</td>' +
                            '<td style="padding: 12px; border: 1px solid #ddd;">' + (log.fullName || '') + '</td>' +
                            '<td style="padding: 12px; border: 1px solid #ddd;">' + (log.type || '') + '</td>' +
                            '<td style="padding: 12px; border: 1px solid #ddd;">' + statusBadge + '</td>' +
                            '<td style="padding: 12px; border: 1px solid #ddd;">' + (log.location || '') + '</td>' +
                            '<td style="padding: 12px; border: 1px solid #ddd;">' + (log.ipAddress || '') + '</td>' +
                            '</tr>';
                        tbody.append(row);
                    });
                }
                
                var totalItems = window.loginLogoutLogs.length;
                var startEntry = totalItems > 0 ? ((window.loginLogoutCurrentPage - 1) * window.loginLogoutEntriesPerPage) + 1 : 0;
                var endEntry = Math.min(window.loginLogoutCurrentPage * window.loginLogoutEntriesPerPage, totalItems);
                
                var infoText = totalItems === 0 ? 'No entries to display' : 
                    'Showing ' + startEntry + ' to ' + endEntry + ' of ' + totalItems + ' entries';
                $('#login-logout-entries-info').text(infoText);
                
                var prevBtn = $('#login-logout-prev');
                var nextBtn = $('#login-logout-next');
                
                prevBtn.prop('disabled', window.loginLogoutCurrentPage === 1);
                nextBtn.prop('disabled', endEntry >= totalItems);
            };
            
            setTimeout(function() {
                if (!window.loginLogoutDataInitialized) {
                    initLoginLogoutData();
                }
                if (window.loginLogoutLogs.length > 0) {
                    window.loginLogoutCurrentPage = 1;
                    renderLoginLogoutTable();
                }
            }, 500);
            
            $('#login-logout-prev').off('click').on('click', function(e) {
                e.preventDefault();
                if (window.loginLogoutCurrentPage > 1) {
                    window.loginLogoutCurrentPage--;
                    renderLoginLogoutTable();
                }
            });
            
            $('#login-logout-next').off('click').on('click', function(e) {
                e.preventDefault();
                var totalItems = window.loginLogoutLogs.length;
                var endEntry = Math.min(window.loginLogoutCurrentPage * window.loginLogoutEntriesPerPage, totalItems);
                if (endEntry < totalItems) {
                    window.loginLogoutCurrentPage++;
                    renderLoginLogoutTable();
                }
            });
            
            entriesDropdown.off('change').on('change', function() {
                var newEntriesPerPage = parseInt($(this).val()) || 10;
                window.loginLogoutEntriesPerPage = newEntriesPerPage;
                window.loginLogoutCurrentPage = 1;
                renderLoginLogoutTable();
            });
        }
    })();

    if (typeof require !== 'undefined' && typeof require.config !== 'undefined') {
        require(['jquery', 'domReady!'], function($) {
            window.$ = $;
            window.jQuery = $;
        document.addEventListener('logsTypeChanged', function(e) {
            const selectedType = e.detail.type;
            const entriesPerPage = parseInt($('#entries_per_page').val()) || 10;
            
            setTimeout(function() {
                if (selectedType === 'login_logout') {
                    window.loginLogoutEntriesPerPage = entriesPerPage;
                    window.loginLogoutCurrentPage = 1;
                    initLoginLogoutData();
                    renderLoginLogoutTable();
                } else if (selectedType === 'active_sessions') {
                    window.activeSessionsEntriesPerPage = entriesPerPage;
                    window.activeSessionsCurrentPage = 1;
                    initActiveSessionsData();
                    renderActiveSessionsTable();
                } else if (selectedType === 'concurrent_sessions') {
                    window.concurrentSessionsEntriesPerPage = entriesPerPage;
                    window.concurrentSessionsCurrentPage = 1;
                    initConcurrentSessionsData();
                    renderConcurrentSessionsTable();
                }
            }, 50);
        });
        
        if (typeof window.loginLogoutLogs === 'undefined') {
            window.loginLogoutLogs = [];
            window.loginLogoutCurrentPage = 1;
            window.loginLogoutEntriesPerPage = 10;
        }
        
        function initLoginLogoutData() {
            if (window.loginLogoutDataInitialized && window.loginLogoutLogs.length > 0) {
                return;
            }
            
            window.loginLogoutLogs = [];
            const tbody = $('#login-logout-tbody');
            const rows = tbody.find('tr');
            
            rows.each(function() {
                const $row = $(this);
                const $cells = $row.find('td');
                
                if ($cells.length > 1 && !$cells.attr('colspan')) {
                    const checkbox = $row.find('.row-checkbox');
                    const row = {
                        id: checkbox.length ? checkbox.val() : '',
                        loggedAt: $cells.eq(1).text().trim(),
                        username: $cells.eq(2).text().trim(),
                        fullName: $cells.eq(3).text().trim(),
                        type: $cells.eq(4).text().trim(),
                        status: $cells.eq(5).html(),
                        location: $cells.eq(6).text().trim(),
                        ipAddress: $cells.eq(7).text().trim()
                    };
                    window.loginLogoutLogs.push(row);
                }
            });
            if (typeof window.originalLoginLogoutLogs === 'undefined') {
                window.originalLoginLogoutLogs = [];
            }
            window.originalLoginLogoutLogs = window.loginLogoutLogs.slice();
            window.loginLogoutDataInitialized = true;
        }
        
        function formatStatusBadge(statusHtml) {
            if (statusHtml && statusHtml.indexOf('status-badge') !== -1) {
                return statusHtml;
            }
            const statusText = $(statusHtml).text() || statusHtml || '';
            const statusLower = statusText.toLowerCase().trim();
            let statusClass = 'status-failed';
            if (statusLower === 'success') {
                statusClass = 'status-success';
            } else if (statusLower === 'failed' || statusLower === 'failure') {
                statusClass = 'status-failed';
            }
            return '<span class="status-badge ' + statusClass + '">' + statusText + '</span>';
        }
        
        window.renderLoginLogoutTable = function() {
            const startIndex = (window.loginLogoutCurrentPage - 1) * window.loginLogoutEntriesPerPage;
            const endIndex = startIndex + window.loginLogoutEntriesPerPage;
            const paginatedLogs = window.loginLogoutLogs.slice(startIndex, endIndex);
            
            const tbody = $('#login-logout-tbody');
            tbody.empty();
            
            if (paginatedLogs.length === 0) {
                tbody.append(`
                    <tr style="background-color: #fff;">
                        <td colspan="8" style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            No login/logout logs found.
                        </td>
                    </tr>
                `);
            } else {
                paginatedLogs.forEach(function(log) {
                    const statusBadge = formatStatusBadge(log.status || '');
                    const row = `
                        <tr style="background-color: #fff;">
                            <td style="padding: 12px; border: 1px solid #ddd;">
                                <input type="checkbox" class="row-checkbox" value="${log.id}" />
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.loggedAt}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.username}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.fullName}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.type}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${statusBadge}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.location}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.ipAddress}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
            
            updateLoginLogoutPagination();
        };
        
        function updateLoginLogoutPagination() {
            const totalItems = window.loginLogoutLogs.length;
            const totalPages = Math.ceil(totalItems / window.loginLogoutEntriesPerPage) || 1;
            const startEntry = totalItems > 0 ? ((window.loginLogoutCurrentPage - 1) * window.loginLogoutEntriesPerPage) + 1 : 0;
            const endEntry = Math.min(window.loginLogoutCurrentPage * window.loginLogoutEntriesPerPage, totalItems);
            
            if (totalItems === 0) {
                $('#login-logout-entries-info').text('No entries to display');
            } else {
                $('#login-logout-entries-info').text(`Showing ${startEntry} to ${endEntry} of ${totalItems} entries`);
            }
            
            const prevBtn = $('#login-logout-prev');
            const nextBtn = $('#login-logout-next');
            
            prevBtn.prop('disabled', window.loginLogoutCurrentPage === 1);
            nextBtn.prop('disabled', endEntry >= totalItems);
            
            $('#select-all-login-logout').prop('checked', false);
        }
        

        
        function initRoleLogsData() {
            if (roleLogsDataInitialized && roleLogs.length > 0) {
                return;
            }
            
            roleLogs = [];
            $('#role-logs-tbody tr').each(function() {
                const $row = $(this);
                const $cells = $row.find('td');
                
                // Skip "no data" rows (rows with colspan or only 1 cell)
                if ($cells.length > 1 && !$cells.attr('colspan')) {
                    const checkbox = $row.find('.row-checkbox');
                    const row = {
                        id: checkbox.length ? checkbox.val() : '',
                        loggedAt: $cells.eq(1).text().trim(),
                        username: $cells.eq(2).text().trim(),
                        logType: $cells.eq(3).text().trim(),
                        action: $cells.eq(4).text().trim(),
                        targetName: $cells.eq(5).text().trim(),
                        description: $cells.eq(6).text().trim(),
                        ipAddress: $cells.eq(7).text().trim(),
                        view: $cells.eq(8).html()
                    };
                    roleLogs.push(row);
                }
            });
            // Store a copy for search functionality
            if (typeof window.originalRoleLogs === 'undefined') {
                window.originalRoleLogs = [];
            }
            window.originalRoleLogs = roleLogs.slice();
            roleLogsDataInitialized = true; // Mark as initialized
        }
        
        // Render role logs table
        function renderRoleLogsTable() {
            const tbody = $('#role-logs-tbody');
            tbody.empty();
            
            if (roleLogs.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="9" class="upgrade-message">
                            Upgrade to <strong>Premium</strong> to enable Admin Role Logs.
                        </td>
                    </tr>
                `);
            } 
            
        }
        
        function initActionData() {
            if (actionDataInitialized && actionLogs.length > 0) {
                return;
            }
            
            actionLogs = [];
            $('#action-tbody tr').each(function() {
                const $row = $(this);
                const $cells = $row.find('td');
                
                if ($cells.length > 1 && !$cells.attr('colspan')) {
                    const checkbox = $row.find('.row-checkbox');
                    const changesCell = $cells.eq(8);
                    const changesButton = changesCell.find('.view-changes-btn');
                    const changesData = changesButton.length ? changesButton.attr('data-changes') : changesCell.html();
                    const entityType = $cells.eq(3).text().trim();
                    const entityId = $cells.eq(4).text().trim();
                    let entityLabel = $cells.eq(5).text().trim();
                    
                    if (!entityLabel || entityLabel === 'N/A') {
                        const entityTypeLower = entityType.toLowerCase();
                        if (['order', 'shipment', 'invoice', 'credit_memo'].includes(entityTypeLower)) {
                            entityLabel = 'Order #' + entityId;
                        } else {
                            entityLabel = 'N/A';
                        }
                    }
                    
                    const row = {
                        id: checkbox.length ? checkbox.val() : '',
                        loggedAt: $cells.eq(1).text().trim(),
                        username: $cells.eq(2).text().trim(),
                        entityType: entityType,
                        entityId: entityId,
                        entityLabel: entityLabel,
                        action: $cells.eq(6).text().trim(),
                        ipAddress: $cells.eq(7).text().trim(),
                        changes: changesData || '-'
                    };
                    actionLogs.push(row);
                }
            });
            if (typeof window.originalActionLogs === 'undefined') {
                window.originalActionLogs = [];
            }
            window.originalActionLogs = actionLogs.slice();
            actionDataInitialized = true;
        }
        
        function renderActionTable() {
            const startIndex = (actionCurrentPage - 1) * actionEntriesPerPage;
            const endIndex = startIndex + actionEntriesPerPage;
            const paginatedLogs = actionLogs.slice(startIndex, endIndex);
            
            const tbody = $('#action-tbody');
            tbody.empty();
            
            if (paginatedLogs.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="9" class="upgrade-message">
                            Upgrade to <strong>Premium</strong> to enable Admin Activity Logging.
                        </td>
                    </tr>
                `);
            }
            
            updateActionPagination();
        }
        
        function updateActionPagination() {
            const totalItems = actionLogs.length;
            const startEntry = totalItems > 0 ? ((actionCurrentPage - 1) * actionEntriesPerPage) + 1 : 0;
            const endEntry = Math.min(actionCurrentPage * actionEntriesPerPage, totalItems);
            
            if (totalItems === 0) {
                $('#action-entries-info').text('No entries to display');
            } else {
                $('#action-entries-info').text(`Showing ${startEntry} to ${endEntry} of ${totalItems} entries`);
            }
            
        }
        
        $('#login-logout-prev').on('click', function() {
            if (window.loginLogoutCurrentPage > 1) {
                window.loginLogoutCurrentPage--;
                renderLoginLogoutTable();
            }
        });
        
        $('#login-logout-next').on('click', function() {
            var totalItems = window.loginLogoutLogs.length;
            var endEntry = Math.min(window.loginLogoutCurrentPage * window.loginLogoutEntriesPerPage, totalItems);
            if (endEntry < totalItems) {
                window.loginLogoutCurrentPage++;
                renderLoginLogoutTable();
            }
        });
        
        window.activeSessionsLogs = [];
        window.originalActiveSessionsLogs = [];
        window.activeSessionsCurrentPage = 1;
        window.activeSessionsEntriesPerPage = 10;
        window.activeSessionsDataInitialized = false;
        
        function initActiveSessionsData() {
            if (window.activeSessionsDataInitialized && window.activeSessionsLogs.length > 0) {
                return;
            }
            
            window.activeSessionsLogs = [];
            let rowIndex = 1;
            $('#active-sessions-tbody tr').each(function() {
                const $row = $(this);
                const $cells = $row.find('td');
                
                if ($cells.length > 1 && !$cells.attr('colspan')) {
                    const row = {
                        id: $cells.eq(0).text().trim(), // ID from first column
                        rowIndex: rowIndex, // Store row index for sorting
                        loggedAt: $cells.eq(1).text().trim(),
                        username: $cells.eq(2).text().trim(),
                        fullName: $cells.eq(3).text().trim(),
                        ipAddress: $cells.eq(4).text().trim(),
                        location: $cells.eq(5).text().trim(),
                        recentActivity: $cells.eq(6).text().trim()
                    };
                    window.activeSessionsLogs.push(row);
                    rowIndex++;
                }
            });
            window.originalActiveSessionsLogs = window.activeSessionsLogs.slice();
            window.activeSessionsDataInitialized = true;
        }
        
        window.renderActiveSessionsTable = function() {
            const startIndex = (window.activeSessionsCurrentPage - 1) * window.activeSessionsEntriesPerPage;
            const endIndex = startIndex + window.activeSessionsEntriesPerPage;
            const paginatedLogs = window.activeSessionsLogs.slice(startIndex, endIndex);
            
            const tbody = $('#active-sessions-tbody');
            tbody.empty();
            
            if (paginatedLogs.length === 0) {
                tbody.append(`
                    <tr style="background-color: #fff;">
                        <td colspan="7" style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            No active sessions found.
                        </td>
                    </tr>
                `);
            } else {
                paginatedLogs.forEach(function(log, index) {
                    const rowId = startIndex + index + 1; // Calculate row ID based on pagination
                    const row = `
                        <tr style="background-color: #fff;">
                            <td style="padding: 12px; border: 1px solid #ddd;">${rowId}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.loggedAt}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.username}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.fullName}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.ipAddress}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.location}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.recentActivity}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
            
            updateActiveSessionsPagination();
        };
        
        function updateActiveSessionsPagination() {
            const totalItems = window.activeSessionsLogs.length;
            const totalPages = Math.ceil(totalItems / window.activeSessionsEntriesPerPage) || 1;
            const startEntry = totalItems > 0 ? ((window.activeSessionsCurrentPage - 1) * window.activeSessionsEntriesPerPage) + 1 : 0;
            const endEntry = Math.min(window.activeSessionsCurrentPage * window.activeSessionsEntriesPerPage, totalItems);
            
            if (totalItems === 0) {
                $('#active-sessions-entries-info').text('No entries to display');
            } else {
                $('#active-sessions-entries-info').text(`Showing ${startEntry} to ${endEntry} of ${totalItems} entries`);
            }
            
            const prevBtn = $('#active-sessions-prev');
            const nextBtn = $('#active-sessions-next');
            
            prevBtn.prop('disabled', window.activeSessionsCurrentPage === 1);
            nextBtn.prop('disabled', endEntry >= totalItems);
        }
        
        $('#active-sessions-prev').off('click').on('click', function(e) {
            e.preventDefault();
            if (window.activeSessionsCurrentPage > 1) {
                window.activeSessionsCurrentPage--;
                renderActiveSessionsTable();
            }
        });
        
        $('#active-sessions-next').off('click').on('click', function(e) {
            e.preventDefault();
            const totalItems = window.activeSessionsLogs.length;
            const endEntry = Math.min(window.activeSessionsCurrentPage * window.activeSessionsEntriesPerPage, totalItems);
            if (endEntry < totalItems) {
                window.activeSessionsCurrentPage++;
                renderActiveSessionsTable();
            }
        });
        
        window.concurrentSessionsLogs = [];
        window.originalConcurrentSessionsLogs = [];
        window.concurrentSessionsCurrentPage = 1;
        window.concurrentSessionsEntriesPerPage = 10;
        window.concurrentSessionsDataInitialized = false;
        
        function initConcurrentSessionsData() {
            if (window.concurrentSessionsDataInitialized && window.concurrentSessionsLogs.length > 0) {
                return;
            }
            
            window.concurrentSessionsLogs = [];
            let rowIndex = 1;
            $('#concurrent-sessions-tbody tr').each(function() {
                const $row = $(this);
                const $cells = $row.find('td');
                
                if ($cells.length > 1 && !$cells.attr('colspan')) {
                    const userId = $row.attr('data-user-id') || '';
                    const sessionCount = $row.find('.session-count');
                    const row = {
                        id: userId,
                        rowIndex: rowIndex, // Store row index for sorting
                        username: $cells.eq(1).text().trim(),
                        fullName: $cells.eq(2).text().trim(),
                        activeSessions: sessionCount.length ? sessionCount.text().trim() : $cells.eq(3).text().trim()
                    };
                    window.concurrentSessionsLogs.push(row);
                    rowIndex++;
                }
            });
            window.originalConcurrentSessionsLogs = window.concurrentSessionsLogs.slice();
            window.concurrentSessionsDataInitialized = true;
        }
        
        window.renderConcurrentSessionsTable = function() {
            const startIndex = (window.concurrentSessionsCurrentPage - 1) * window.concurrentSessionsEntriesPerPage;
            const endIndex = startIndex + window.concurrentSessionsEntriesPerPage;
            const paginatedLogs = window.concurrentSessionsLogs.slice(startIndex, endIndex);
            
            const tbody = $('#concurrent-sessions-tbody');
            tbody.empty();
            
            if (paginatedLogs.length === 0) {
                tbody.append(`
                    <tr style="background-color: #fff;">
                        <td colspan="5" style="padding: 12px; border: 1px solid #ddd; text-align: center;">
                            No concurrent sessions found.
                        </td>
                    </tr>
                `);
            } else {
                paginatedLogs.forEach(function(log, index) {
                    const rowId = startIndex + index + 1; // Calculate row ID based on pagination
                    const mainRow = `
                        <tr class="concurrent-session-row" data-user-id="${log.id}" style="background-color: #fff;">
                            <td style="padding: 12px; border: 1px solid #ddd;">${rowId}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.username}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">${log.fullName}</td>
                            <td style="padding: 12px; border: 1px solid #ddd;">
                                <span class="session-count" data-user-id="${log.id}">
                                    ${log.activeSessions}
                                </span>
                            </td>
                            <td style="padding: 12px; border: 1px solid #ddd;">
                                <button type="button" class="action-default view-session-btn" data-user-id="${log.id}" title="View Session Details">
                                    View
                                </button>
                            </td>
                        </tr>
                    `;
                    tbody.append(mainRow);
                });
            }
            
            updateConcurrentSessionsPagination();
        };
        
        function updateConcurrentSessionsPagination() {
            const totalItems = window.concurrentSessionsLogs.length;
            const startEntry = totalItems > 0 ? ((window.concurrentSessionsCurrentPage - 1) * window.concurrentSessionsEntriesPerPage) + 1 : 0;
            const endEntry = Math.min(window.concurrentSessionsCurrentPage * window.concurrentSessionsEntriesPerPage, totalItems);
            
            if (totalItems === 0) {
                $('#concurrent-sessions-entries-info').text('No entries to display');
            } else {
                $('#concurrent-sessions-entries-info').text(`Showing ${startEntry} to ${endEntry} of ${totalItems} entries`);
            }
            
            const prevBtn = $('#concurrent-sessions-prev');
            const nextBtn = $('#concurrent-sessions-next');
            
            prevBtn.prop('disabled', window.concurrentSessionsCurrentPage === 1);
            nextBtn.prop('disabled', endEntry >= totalItems);
        }
        
        $('#concurrent-sessions-prev').off('click').on('click', function(e) {
            e.preventDefault();
            if (window.concurrentSessionsCurrentPage > 1) {
                window.concurrentSessionsCurrentPage--;
                renderConcurrentSessionsTable();
            }
        });
        
        $('#concurrent-sessions-next').off('click').on('click', function(e) {
            e.preventDefault();
            const totalItems = window.concurrentSessionsLogs.length;
            const endEntry = Math.min(window.concurrentSessionsCurrentPage * window.concurrentSessionsEntriesPerPage, totalItems);
            if (endEntry < totalItems) {
                window.concurrentSessionsCurrentPage++;
                renderConcurrentSessionsTable();
            }
        });
        
        $(document).on('change', '#select-all-login-logout', function() {
            $('#login-logout-tbody .row-checkbox').prop('checked', $(this).is(':checked'));
        });
        
        $(document).on('change', '#login-logout-tbody .row-checkbox', function() {
            const allCheckboxes = $('#login-logout-tbody .row-checkbox');
            const checkedCheckboxes = $('#login-logout-tbody .row-checkbox:checked');
            $('#select-all-login-logout').prop('checked', allCheckboxes.length === checkedCheckboxes.length);
        });
        
        
        $('#search_users').on('keyup', function() {
            const searchTerm = $(this).val().toLowerCase();
            const currentLogType = $('#logs_type').val() || 'login_logout';
            
            if (searchTerm === '') {
                if (currentLogType === 'login_logout' && window.originalLoginLogoutLogs && window.originalLoginLogoutLogs.length > 0) {
                    window.loginLogoutLogs = window.originalLoginLogoutLogs.slice();
                    window.loginLogoutCurrentPage = 1;
                    renderLoginLogoutTable();
                } else if (currentLogType === 'active_sessions' && window.originalActiveSessionsLogs && window.originalActiveSessionsLogs.length > 0) {
                    window.activeSessionsLogs = window.originalActiveSessionsLogs.slice();
                    window.activeSessionsCurrentPage = 1;
                    renderActiveSessionsTable();
                } else if (currentLogType === 'concurrent_sessions' && window.originalConcurrentSessionsLogs && window.originalConcurrentSessionsLogs.length > 0) {
                    window.concurrentSessionsLogs = window.originalConcurrentSessionsLogs.slice();
                    window.concurrentSessionsCurrentPage = 1;
                    renderConcurrentSessionsTable();
                }
            } else {
                if (currentLogType === 'login_logout' && window.originalLoginLogoutLogs && window.originalLoginLogoutLogs.length > 0) {
                    window.loginLogoutLogs = window.originalLoginLogoutLogs.filter(function(log) {
                        return log.username.toLowerCase().includes(searchTerm) ||
                            log.fullName.toLowerCase().includes(searchTerm) ||
                            log.ipAddress.toLowerCase().includes(searchTerm);
                    });
                    window.loginLogoutCurrentPage = 1;
                    renderLoginLogoutTable();
                } else if (currentLogType === 'active_sessions' && window.originalActiveSessionsLogs && window.originalActiveSessionsLogs.length > 0) {
                    window.activeSessionsLogs = window.originalActiveSessionsLogs.filter(function(log) {
                        return log.username.toLowerCase().includes(searchTerm) ||
                            log.fullName.toLowerCase().includes(searchTerm) ||
                            log.ipAddress.toLowerCase().includes(searchTerm) ||
                            log.location.toLowerCase().includes(searchTerm);
                    });
                    window.activeSessionsCurrentPage = 1;
                    renderActiveSessionsTable();
                } else if (currentLogType === 'concurrent_sessions' && window.originalConcurrentSessionsLogs && window.originalConcurrentSessionsLogs.length > 0) {
                    window.concurrentSessionsLogs = window.originalConcurrentSessionsLogs.filter(function(log) {
                        return log.username.toLowerCase().includes(searchTerm) ||
                            log.fullName.toLowerCase().includes(searchTerm);
                    });
                    window.concurrentSessionsCurrentPage = 1;
                    renderConcurrentSessionsTable();
                }
            }
        });
        
        $(document).on('click', '[data-tab="logs_view"]', function() {
            setTimeout(function() {
                initializeOnLoad();
            }, 100);
        });
        
        function initializeOnLoad() {
            window.initializeOnLoad = initializeOnLoad;
            
            let entriesPerPage = parseInt($('#entries_per_page').val());
            
            if (!entriesPerPage || isNaN(entriesPerPage)) {
                const urlParams = new URLSearchParams(window.location.search);
                entriesPerPage = parseInt(urlParams.get('entries_per_page')) || 10;
            }
            
            if ($('#entries_per_page').val() != entriesPerPage) {
                $('#entries_per_page').val(entriesPerPage);
            }
            
            window.loginLogoutEntriesPerPage = entriesPerPage;
            window.activeSessionsEntriesPerPage = entriesPerPage;
            window.concurrentSessionsEntriesPerPage = entriesPerPage;
            
            window.loginLogoutCurrentPage = 1;
            window.activeSessionsCurrentPage = 1;
            window.concurrentSessionsCurrentPage = 1;
            
            const loginLogoutTbody = $('#login-logout-tbody');
            
            if (loginLogoutTbody.length > 0 && loginLogoutTbody.find('tr').length > 0 && !window.loginLogoutDataInitialized) {
                initLoginLogoutData();
            }
            
            const activeSessionsTbody = $('#active-sessions-tbody');
            const concurrentSessionsTbody = $('#concurrent-sessions-tbody');
            if (activeSessionsTbody.length > 0 && activeSessionsTbody.find('tr').length > 0 && !window.activeSessionsDataInitialized) {
                initActiveSessionsData();
            }
            if (concurrentSessionsTbody.length > 0 && concurrentSessionsTbody.find('tr').length > 0 && !window.concurrentSessionsDataInitialized) {
                initConcurrentSessionsData();
            }
            
            if (window.loginLogoutDataInitialized) {
                renderLoginLogoutTable();
            }
            if (window.activeSessionsDataInitialized) {
                renderActiveSessionsTable();
            }
            if (window.concurrentSessionsDataInitialized) {
                renderConcurrentSessionsTable();
            }
            
            $('#entries_per_page').off('change').on('change', function() {
                const newEntriesPerPage = parseInt($(this).val()) || 10;
                window.loginLogoutEntriesPerPage = newEntriesPerPage;
                window.activeSessionsEntriesPerPage = newEntriesPerPage;
                window.concurrentSessionsEntriesPerPage = newEntriesPerPage;
                
                window.loginLogoutCurrentPage = 1;
                window.activeSessionsCurrentPage = 1;
                window.concurrentSessionsCurrentPage = 1;
                
                if (window.loginLogoutDataInitialized) {
                    renderLoginLogoutTable();
                }
                if (window.activeSessionsDataInitialized) {
                    renderActiveSessionsTable();
                }
                if (window.concurrentSessionsDataInitialized) {
                    renderConcurrentSessionsTable();
                }
            });
        }
        
        $(document).ready(function() {
            const isLogsViewActive = $('#tab-logs_view').hasClass('active') || 
                                    window.location.search.includes('active_tab=logs_view') ||
                                    $('#tab-logs_view').is(':visible') ||
                                    $('[data-tab="logs_view"]').hasClass('active');
            
            const hasEntriesDropdown = $('#entries_per_page').length > 0;
            
            if (hasEntriesDropdown) {
                setTimeout(function() {
                    initializeOnLoad();
                }, 300);
            }
        });
        
        $(window).on('load', function() {
            if ($('#entries_per_page').length > 0) {
                setTimeout(function() {
                    initializeOnLoad();
                }, 500);
            }
        });
        });
    }
    (function() {
        function initWhenReady() {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initWhenReady);
                return;
            }
            
            setTimeout(function() {
                if (typeof jQuery !== 'undefined') {
                    var $ = jQuery;
                    
                    if ($('#entries_per_page').length > 0) {
                        if (typeof initializeOnLoad === 'function') {
                            initializeOnLoad();
                        } else {
                            setTimeout(function() {
                                if (typeof initializeOnLoad === 'function') {
                                    initializeOnLoad();
                                }
                            }, 1000);
                        }
                    }
                }
            }, 1000);
        }
        
        initWhenReady();
    })();
</script>

<script>
    require(['jquery', 'domReady!'], function($) {
        function toggleSearchAndExport(logType) {
            const searchWrapper = $('.search-wrapper');
            const exportDropdownWrapper = $('#export-dropdown-wrapper');
            const logsActionsWrapper = $('#logs-actions-wrapper');
            const searchInput = $('#search_users');
            const exportToggle = $('#export-dropdown-toggle');
            const exportRadios = $('.export-radio');
            const logsActionsSelect = $('#logs_actions');
            
            // Enable search for all log types
            searchInput.prop('disabled', false);
            searchInput.css({
                'opacity': '1',
                'cursor': 'text',
                'background-color': '#fff'
            });
            searchWrapper.css('opacity', '1');
            
            if (logType === 'login_logout') {
                // Show and enable "Select Actions" dropdown for Login/Logout Logs
                logsActionsWrapper.show();
                logsActionsSelect.prop('disabled', false);
                logsActionsSelect.val('default');
                logsActionsSelect.css({
                    'opacity': '1',
                    'cursor': 'pointer',
                    'background-color': '#fff'
                });
                
                // Show and enable Export dropdown for Login/Logout Logs
                exportDropdownWrapper.show();
                exportToggle.prop('disabled', false);
                exportToggle.css({
                    'opacity': '1',
                    'cursor': 'pointer',
                    'background-color': '#fff'
                });
                exportRadios.prop('disabled', false);
            } else {
                // Hide "Select Actions" dropdown for all other log types
                logsActionsWrapper.hide();
                logsActionsSelect.val('default');
                
                // Hide Export dropdown for all other log types
                exportDropdownWrapper.hide();
                exportRadios.prop('checked', false);
            }
        }
        
        $('#logs_type').on('change', function() {
            const selectedType = $(this).val();
            toggleSearchAndExport(selectedType);
        });
        
        $(document).ready(function() {
            const currentLogType = $('#logs_type').val() || 'login_logout';
            toggleSearchAndExport(currentLogType);
        });
        
        $(document).on('click', '[data-tab="logs_view"]', function() {
            setTimeout(function() {
                const currentLogType = $('#logs_type').val() || 'login_logout';
                toggleSearchAndExport(currentLogType);
            }, 100);
        });
        
        document.addEventListener('logsTypeChanged', function(e) {
            const selectedType = e.detail.type;
            toggleSearchAndExport(selectedType);
        });
        
        // Export dropdown click handler - no longer needed since dropdown is hidden for non-login_logout types
        
        window.columnMapping = {
            'login_logout': {
                'logged_in_at': 'loggedAt',
                'username': 'username',
                'full_name': 'fullName',
                'type': 'type',
                'status': 'status',
                'location': 'location',
                'ip_address': 'ipAddress'
            },
            'active_sessions': {
                'id': 'rowIndex',
                'logged_in_at': 'loggedAt',
                'username': 'username',
                'full_name': 'fullName',
                'ip_address': 'ipAddress',
                'location': 'location',
                'recent_activity': 'recentActivity'
            },
            'concurrent_sessions': {
                'id': 'rowIndex',
                'username': 'username',
                'full_name': 'fullName',
                'active_sessions': 'activeSessions'
            }
        };
        
        window.getSortValue = function(log, columnKey, currentLogType) {
            const mapping = window.columnMapping[currentLogType];
            if (!mapping || !mapping[columnKey]) {
                return '';
            }
            const property = mapping[columnKey];
            let value = log[property] || '';
            
            if (typeof value === 'string' && value.includes('<')) {
                const temp = document.createElement('div');
                temp.innerHTML = value;
                value = temp.textContent || temp.innerText || '';
            }
            
            return value.toString().trim();
        };
        
        window.sortDataArray = function(dataArray, columnKey, order, currentLogType) {
            if (!dataArray || dataArray.length === 0) {
                return;
            }
            
            dataArray.sort(function(a, b) {
                let cellA = window.getSortValue(a, columnKey, currentLogType);
                let cellB = window.getSortValue(b, columnKey, currentLogType);
                
                const dateA = Date.parse(cellA);
                const dateB = Date.parse(cellB);
                if (!isNaN(dateA) && !isNaN(dateB)) {
                    return order === 'asc' ? dateA - dateB : dateB - dateA;
                }
                
                const numA = parseFloat(cellA);
                const numB = parseFloat(cellB);
                if (!isNaN(numA) && !isNaN(numB) && cellA !== '' && cellB !== '') {
                    return order === 'asc' ? numA - numB : numB - numA;
                } 
                return order === 'asc'
                    ? cellA.localeCompare(cellB)
                    : cellB.localeCompare(cellA);
            });
        };
        
        $(document).on('click', 'th.sortable', function() {
            const $header = $(this);
            const column = $header.data('column');
            const currentOrder = $header.data('order') || 'asc';
            const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';
            const currentLogType = $('#logs_type').val() || 'login_logout';
            
            $header.closest('table').find('th.sortable').removeClass('asc desc').removeData('order');
            
            $header.addClass(newOrder).data('order', newOrder);
            
            if (currentLogType === 'login_logout' && window.loginLogoutLogs) {
                if (typeof window.sortDataArray === 'function') {
                    window.sortDataArray(window.loginLogoutLogs, column, newOrder, currentLogType);
                }
                window.loginLogoutCurrentPage = 1;
                if (typeof window.renderLoginLogoutTable === 'function') {
                    window.renderLoginLogoutTable();
                }
            } else if (currentLogType === 'active_sessions' && window.activeSessionsLogs) {
                if (typeof window.sortDataArray === 'function') {
                    window.sortDataArray(window.activeSessionsLogs, column, newOrder, currentLogType);
                }
                window.activeSessionsCurrentPage = 1;
                if (typeof window.renderActiveSessionsTable === 'function') {
                    window.renderActiveSessionsTable();
                }
            } else if (currentLogType === 'concurrent_sessions' && window.concurrentSessionsLogs) {
                if (typeof window.sortDataArray === 'function') {
                    window.sortDataArray(window.concurrentSessionsLogs, column, newOrder, currentLogType);
                }
                window.concurrentSessionsCurrentPage = 1;
                if (typeof window.renderConcurrentSessionsTable === 'function') {
                    window.renderConcurrentSessionsTable();
                }
            }
        });
        
        function formatJSON(jsonString) {
            try {
                const obj = JSON.parse(jsonString);
                return JSON.stringify(obj, null, 2);
            } catch (e) {
                return jsonString;
            }
        }
        
        function openChangesModal(changesJson) {
            const formattedJson = formatJSON(changesJson);
            $('#changes-json-content').text(formattedJson);
            $('#changes-json-modal').fadeIn(200);
        }
        
        function closeChangesModal() {
            $('#changes-json-modal').fadeOut(200);
        }
        
        $(document).on('click', '.view-changes-btn', function(e) {
            const changesJson = $(this).attr('data-changes');
            if (changesJson) {
                e.preventDefault();
                e.stopPropagation();
                openChangesModal(changesJson);
            }
        });
        
        $(document).on('click', '.changes-modal-close', function(e) {
            e.preventDefault();
            closeChangesModal();
        });
        
        $(document).on('click', '.changes-modal-overlay', function(e) {
            if ($(e.target).hasClass('changes-modal-overlay')) {
                closeChangesModal();
            }
        });
        
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape' && $('#changes-json-modal').is(':visible')) {
                closeChangesModal();
            }
        });
        
        // Session Details Popup Functions
        function openSessionDetailsPopup(userId) {
            const popup = $('#session-details-popup');
            const loading = $('#session-details-loading');
            const error = $('#session-details-error');
            const table = $('#session-details-table');
            const tbody = $('#session-details-tbody');
            
            // Show popup and loading state
            popup.fadeIn(200);
            loading.show();
            error.hide();
            table.hide();
            tbody.empty();
            
            // Fetch session data
            const url = '<?= $block->escapeUrl($block->getUrl("adminlogs/concurrentsessions/getsessions")) ?>';
            $.ajax({
                url: url,
                type: 'GET',
                data: {
                    user_id: userId,
                    form_key: $('input[name="form_key"]').val()
                },
                dataType: 'json',
                success: function(response) {
                    loading.hide();
                    
                    if (response.success && response.sessions && response.sessions.length > 0) {
                        // Populate table with session data
                        response.sessions.forEach(function(session) {
                            const row = `
                                <tr>
                                    <td>${session.ip || 'Unknown'}</td>
                                    <td>${session.location || 'Unknown'}</td>
                                    <td>${session.login_time || 'N/A'}</td>
                                    <td>${session.last_activity || 'N/A'}</td>
                                    <td>
                                        <div class="terminate-session-btn-wrapper">
                                            <button type="button" class="action-default terminate-session-btn" data-session-id="${session.id}">
                                                <span>Terminate</span>
                                            </button>
                                            <jdiv class="terminate-tooltip">
                                                You can terminate active sessions by upgrading to the <a href="https://plugins.miniorange.com/magento-admin-logs-activity-monitor#Pricing" target="_blank" class="terminate-tooltip-link">premium</a> module.
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            `;
                            tbody.append(row);
                        });
                        table.show();
                    } else {
                        error.find('span').text(response.message || 'No active sessions found for this user.');
                        error.show();
                    }
                },
                error: function(xhr, status, error) {
                    loading.hide();
                    error.find('span').text('Error loading session details. Please try again.');
                    error.show();
                }
            });
        }
        
        function closeSessionDetailsPopup() {
            $('#session-details-popup').fadeOut(200);
        }
        
        // Handle View button clicks
        $(document).on('click', '.view-session-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const userId = $(this).data('user-id');
            if (userId) {
                openSessionDetailsPopup(userId);
            }
        });
        
        // Handle close button
        $(document).on('click', '.session-details-close', function(e) {
            e.preventDefault();
            closeSessionDetailsPopup();
        });
        
        // Close popup when clicking outside
        $(document).on('click', '.session-details-popup', function(e) {
            if ($(e.target).hasClass('session-details-popup')) {
                closeSessionDetailsPopup();
            }
        });
        
        // Close popup on Escape key
        $(document).on('keydown', function(e) {
            if (e.key === 'Escape' && $('#session-details-popup').is(':visible')) {
                closeSessionDetailsPopup();
            }
        });
        
        // Handle Terminate button tooltip on click
        $(document).on('click', '.terminate-session-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const wrapper = $(this).closest('.terminate-session-btn-wrapper');
            
            // Toggle tooltip visibility
            if (wrapper.hasClass('show-tooltip')) {
                wrapper.removeClass('show-tooltip');
            } else {
                // Hide all other tooltips
                $('.terminate-session-btn-wrapper').removeClass('show-tooltip');
                // Show this tooltip
                wrapper.addClass('show-tooltip');
            }
        });
        
        // Hide tooltip when clicking outside
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.terminate-session-btn-wrapper').length) {
                $('.terminate-session-btn-wrapper').removeClass('show-tooltip');
            }
        });

        // Disable Objects to Log field completely (free extension feature)
        function disableObjectsToLog() {
            var searchInput = $('#objects_to_log_search');
            var displayDiv = $('#objects_to_log_display');
            
            if (searchInput.length && displayDiv.length) {
                searchInput.prop('disabled', true);
                displayDiv.css({
                    'pointer-events': 'none',
                    'opacity': '0.6',
                    'background-color': '#f0f0f0'
                });
            }
        }

        disableObjectsToLog();
    });
</script>

